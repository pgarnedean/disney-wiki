<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Disney Wiki Ultimate</title>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap');

    :root {
        --primary-color: #1a2b4c; /* ç´ºè‰² */
        --accent-color: #c5a059; /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
        --text-color: #333;
        --bg-color: #f4f4f4;
        --sidebar-width: 280px;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Noto Sans JP', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        overflow: hidden;
    }

    /* å·¦å´ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    #sidebar {
        width: var(--sidebar-width);
        background-color: var(--primary-color);
        color: white;
        display: flex;
        flex-direction: column;
        border-right: 2px solid var(--accent-color);
        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        z-index: 10;
        position: relative;
    }

    /* ãƒ­ã‚´ã‚¨ãƒªã‚¢ */
    .logo-area {
        height: 80px;
        display: flex;
        align-items: center;
        padding: 0 15px;
        background-color: #111c33;
        border-bottom: 1px solid var(--accent-color);
        position: relative;
    }

    /* éš ã‚ŒãƒŸãƒƒã‚­ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
    .mickey-icon {
        width: 30px;
        height: 30px;
        position: relative;
        margin-right: 15px;
        flex-shrink: 0;
    }
    .mickey-head {
        width: 18px;
        height: 18px;
        background: white;
        border-radius: 50%;
        position: absolute;
        bottom: 2px;
        left: 6px;
    }
    .mickey-ear {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        position: absolute;
        top: 0;
    }
    .ear-left { left: 2px; }
    .ear-right { right: 2px; }

    /* ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ­ã‚´ç”»åƒ */
    .logo-img {
        max-height: 50px;
        max-width: 180px;
        object-fit: contain;
    }

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
    .search-box {
        padding: 15px;
    }
    .search-box input {
        width: 100%;
        padding: 8px;
        border-radius: 20px;
        border: none;
        outline: none;
        padding-left: 15px;
        box-sizing: border-box;
    }

    /* ãƒšãƒ¼ã‚¸ãƒªã‚¹ãƒˆ */
    #page-list {
        flex-grow: 1;
        overflow-y: auto;
        padding: 10px;
    }
    .page-item {
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .page-item:hover {
        background-color: rgba(255,255,255,0.1);
    }
    .page-item.active {
        background-color: var(--accent-color);
        color: var(--primary-color);
        font-weight: bold;
    }
    .delete-btn {
        background: none;
        border: none;
        color: inherit;
        font-size: 1.2em;
        cursor: pointer;
        opacity: 0.6;
        padding: 0 5px;
    }
    .delete-btn:hover { opacity: 1; }

    /* è¨­å®šãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .settings-area {
        padding: 15px;
        border-top: 1px solid rgba(255,255,255,0.2);
    }
    .settings-btn {
        background: none;
        border: 1px solid rgba(255,255,255,0.5);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8em;
        width: 100%;
        text-align: center;
        transition: 0.3s;
    }
    .settings-btn:hover {
        background: rgba(255,255,255,0.2);
    }

    /* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
    #settings-modal {
        display: none;
        position: fixed;
        bottom: 60px;
        left: 10px;
        width: 250px;
        background: white;
        color: #333;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        z-index: 100;
        padding: 15px;
    }
    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    /* ã‚¹ã‚¤ãƒƒãƒ */
    .switch {
        position: relative;
        display: inline-block;
        width: 34px;
        height: 20px;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 12px;
        width: 12px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(14px); }


    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    #main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        position: relative;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
    .toolbar {
        background-color: white;
        padding: 10px 20px;
        border-bottom: 1px solid #ddd;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    .tool-btn {
        background: #eee;
        border: 1px solid #ccc;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .tool-btn:hover { background: #ddd; }
    .tool-input {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* ç·¨é›†ã‚¨ãƒªã‚¢ */
    #editor-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 40px;
        position: relative;
    }
    
    #wiki-title {
        font-size: 2.5em;
        font-weight: bold;
        color: var(--primary-color);
        border: none;
        width: 100%;
        outline: none;
        background: transparent;
        margin-bottom: 10px;
        font-family: 'Noto Sans JP', serif;
    }

    #wiki-subtitle {
        font-size: 1em;
        color: #666;
        border: none;
        border-bottom: 1px dashed #ccc;
        width: 100%;
        outline: none;
        background: transparent;
        margin-bottom: 20px;
        padding-bottom: 5px;
    }

    #wiki-body {
        min-height: 300px;
        outline: none;
        line-height: 1.6;
    }

    /* wikiå†…ã®è¦ç´ ã‚¹ã‚¿ã‚¤ãƒ« */
    #wiki-body img, #wiki-body video {
        max-width: 100%;
        margin: 10px 0;
        cursor: pointer; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ã‚’ç¤ºã™ */
        border: 2px solid transparent;
    }
    #wiki-body img:hover, #wiki-body video:hover {
        border-color: var(--accent-color);
    }
    
    /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
    #wiki-body a {
        color: #0056b3;
        text-decoration: underline;
        cursor: pointer;
    }

    /* PDFã‚³ãƒ³ãƒ†ãƒŠ (æ“¬ä¼¼) */
    .pdf-container {
        width: 100%;
        height: 500px; /* å›ºå®šé«˜ã• */
        border: 1px solid #ccc;
        background: #525659;
        position: relative;
        overflow: auto; /* PDFå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        margin: 10px 0;
        cursor: pointer;
    }
    .pdf-content {
        width: 100%;
        min-height: 1000px; /* é•·ã„æ–‡æ›¸ã‚’æƒ³å®š */
        background: white;
        position: relative; /* ãƒãƒ¼ã‚«ãƒ¼ã®åŸºæº– */
        padding: 20px;
        box-sizing: border-box;
    }
    /* PDFå†…ã®ãƒãƒ¼ã‚«ãƒ¼ */
    .pdf-marker {
        position: absolute;
        background-color: rgba(255, 255, 0, 0.4);
        border: 1px solid orange;
        cursor: pointer;
        z-index: 5;
    }

    /* --- ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ¢ãƒ¼ãƒ‰ (ç”»åƒ/PDFæ‹¡å¤§) --- */
    .focus-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }
    .focus-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }
    
    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸè¦ç´ ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
    .focus-wrapper {
        position: relative;
        transition: transform 0.1s ease-out; /* ã‚¹ãƒ ãƒ¼ã‚ºãªç§»å‹• */
        will-change: transform;
    }
    
    .focus-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 30px;
        cursor: pointer;
        z-index: 1001;
    }

    /* TOPãƒšãƒ¼ã‚¸ã®è‡ªå‹•ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ */
    #auto-link-btn {
        background-color: var(--accent-color);
        color: var(--primary-color);
        border: none;
        padding: 15px 30px;
        font-size: 1.2em;
        border-radius: 30px;
        cursor: pointer;
        margin-top: 20px;
        font-weight: bold;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    #auto-link-btn:hover {
        transform: scale(1.05);
    }

    /* --- æ¼”å‡ºç”¨CSS --- */
    #fireworks-container {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 9999;
    }
    
    /* ãƒŸãƒƒã‚­ãƒ¼æ¼”å‡º */
    .mickey-effect {
        position: absolute;
        pointer-events: none;
        width: 20px;
        height: 20px;
        background: rgba(255,255,255,0.8);
        border-radius: 50%;
        animation: floatUp 2s ease-out forwards;
        z-index: 9998;
    }
    .mickey-effect::before, .mickey-effect::after {
        content: '';
        position: absolute;
        width: 12px;
        height: 12px;
        background: inherit;
        border-radius: 50%;
        top: -6px;
    }
    .mickey-effect::before { left: -6px; }
    .mickey-effect::after { right: -6px; }
    
    @keyframes floatUp {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-50px) scale(1.5); opacity: 0; }
    }

</style>
</head>
<body>

<div id="settings-modal">
    <div class="setting-row">
        <span>ãƒŸãƒƒã‚­ãƒ¼æ¼”å‡º</span>
        <label class="switch">
            <input type="checkbox" id="toggle-mickey" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div class="setting-row">
        <span>èŠ±ç«æ¼”å‡º</span>
        <label class="switch">
            <input type="checkbox" id="toggle-fireworks" checked>
            <span class="slider"></span>
        </label>
    </div>
    <div style="text-align: right; margin-top: 10px;">
        <button onclick="toggleSettings()" style="padding:5px 10px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div id="focus-overlay" class="focus-overlay">
    <div class="focus-close" onclick="closeFocus()">Ã—</div>
    <div id="focus-content-area" class="focus-wrapper">
        </div>
</div>

<canvas id="fireworks-container"></canvas>

<div id="sidebar">
    <div class="logo-area">
        <div class="mickey-icon">
            <div class="mickey-head"></div>
            <div class="mickey-ear ear-left"></div>
            <div class="mickey-ear ear-right"></div>
        </div>
        <a href="https://fontmeme.com/ja/font-disney-logo/">
            <img src="https://fontmeme.com/permalink/260204/eabb3794.png" alt="font-disney-logo" border="0" class="logo-img">
        </a>
    </div>

    <div class="search-box">
        <input type="text" id="search-input" placeholder="WIKIã‚’æ¤œç´¢ (ã‚µãƒ–é¡Œåå«ã‚€)..." oninput="searchWiki()">
    </div>

    <div id="page-list">
        </div>

    <div class="settings-area">
        <div class="settings-btn" onclick="toggleSettings()">âš™ è¨­å®š</div>
        <div class="settings-btn" onclick="createNewPage()" style="margin-top:5px; background:var(--accent-color); color:var(--primary-color); font-weight:bold;">ï¼‹ æ–°è¦ãƒšãƒ¼ã‚¸</div>
    </div>
</div>

<div id="main-content">
    
    <div id="top-view" style="padding: 50px; text-align: center; display: block;">
        <h1 style="font-size: 3em; color: var(--primary-color);">Welcome to DISNEY WIKI</h1>
        <p>å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ãƒšãƒ¼ã‚¸ã‚’é¸æŠã™ã‚‹ã‹ã€æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
        <button id="auto-link-btn" onclick="runAutoLinker()">å…¨ãƒšãƒ¼ã‚¸è‡ªå‹•ãƒªãƒ³ã‚¯ç”Ÿæˆ</button>
        <p style="font-size:0.8em; color:#666; margin-top:10px;">â€»è¨˜äº‹å†…ã®å˜èªã‚’è‡ªå‹•æ¤œå‡ºã—ã€å¯¾å¿œã™ã‚‹Wikiãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã‚’è²¼ã‚Šã¾ã™ã€‚</p>
    </div>

    <div id="editor-view" style="display: none; flex-direction: column; height: 100%;">
        <div class="toolbar">
            <button class="tool-btn" onclick="execCmd('bold')" title="å¤ªå­—"><b>B</b></button>
            <button class="tool-btn" onclick="execCmd('italic')" title="æ–œä½“"><i>I</i></button>
            <button class="tool-btn" onclick="execCmd('underline')" title="ä¸‹ç·š"><u>U</u></button>
            <div style="width:1px; height:20px; background:#ccc; margin:0 5px;"></div>
            <button class="tool-btn" onclick="addLink()" title="ãƒªãƒ³ã‚¯æŒ¿å…¥">ğŸ”— ãƒªãƒ³ã‚¯</button>
            <button class="tool-btn" onclick="insertImage()" title="ç”»åƒæŒ¿å…¥">ğŸ–¼ ç”»åƒ</button>
            <button class="tool-btn" onclick="insertPDFDemo()" title="PDF(ãƒ‡ãƒ¢)æŒ¿å…¥">ğŸ“„ PDFè¿½åŠ </button>
            <div style="flex-grow:1;"></div>
            <button class="tool-btn" onclick="saveCurrentPage()" style="background:var(--primary-color); color:white;">ä¿å­˜</button>
        </div>

        <div id="editor-container">
            <input type="text" id="wiki-title" placeholder="ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«" oninput="updateCurrentTitle()">
            <input type="text" id="wiki-subtitle" placeholder="ã‚µãƒ–é¡Œå/åˆ¥å (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å¯: ãƒŸãƒƒã‚­ãƒ¼, ãƒã‚¦ã‚¹, ä¸»å½¹)" title="æ¤œç´¢ã‚„è‡ªå‹•ãƒªãƒ³ã‚¯ã«ä½¿ç”¨ã•ã‚Œã¾ã™">
            <div id="wiki-body" contenteditable="true"></div>
        </div>
    </div>

</div>

<script>
    /* ================= åˆæœŸè¨­å®šã¨ãƒ‡ãƒ¼ã‚¿ç®¡ç† ================= */
    let pages = [];
    let currentPageId = null;
    let settings = {
        mickey: true,
        fireworks: true
    };

    // èµ·å‹•æ™‚ã®ãƒ­ãƒ¼ãƒ‰
    window.onload = function() {
        loadData();
        loadSettings();
        renderPageList();
        
        // ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šï¼ˆä¿å­˜å¿˜ã‚Œé˜²æ­¢ç”¨ç°¡æ˜“ï¼‰
        document.getElementById('wiki-body').addEventListener('input', function() {
            // è‡ªå‹•ä¿å­˜ãªã©ã‚’å…¥ã‚ŒãŸã„å ´åˆã¯ã“ã“ã«
        });

        // èŠ±ç«ãƒ«ãƒ¼ãƒ—é–‹å§‹
        requestAnimationFrame(fireworksLoop);
    };

    function loadData() {
        const storedPages = localStorage.getItem('disney_wiki_pages');
        if (storedPages) {
            pages = JSON.parse(storedPages);
        } else {
            // åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
            pages = [
                { id: 1, title: 'ãƒŸãƒƒã‚­ãƒ¼ãƒã‚¦ã‚¹', subtitle: 'ãƒŸãƒƒã‚­ãƒ¼, ã‚¹ã‚¿ã‚¢', content: '<b>ãƒŸãƒƒã‚­ãƒ¼ãƒã‚¦ã‚¹</b>ã¯ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ã™ã€‚<br>å½¼ã¯ä¸–ç•Œä¸­ã§æ„›ã•ã‚Œã¦ã„ã¾ã™ã€‚' },
                { id: 2, title: 'ã‚·ãƒ³ãƒ‡ãƒ¬ãƒ©åŸ', subtitle: 'TDL, ãŠåŸ', content: 'æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã®ã‚·ãƒ³ãƒœãƒ«ã§ã™ã€‚' }
            ];
            saveData();
        }
    }

    function saveData() {
        localStorage.setItem('disney_wiki_pages', JSON.stringify(pages));
    }

    function loadSettings() {
        const s = localStorage.getItem('disney_wiki_settings');
        if (s) {
            settings = JSON.parse(s);
            document.getElementById('toggle-mickey').checked = settings.mickey;
            document.getElementById('toggle-fireworks').checked = settings.fireworks;
        }
        
        // è¨­å®šãƒªã‚¹ãƒŠãƒ¼
        document.getElementById('toggle-mickey').addEventListener('change', (e) => {
            settings.mickey = e.target.checked;
            localStorage.setItem('disney_wiki_settings', JSON.stringify(settings));
        });
        document.getElementById('toggle-fireworks').addEventListener('change', (e) => {
            settings.fireworks = e.target.checked;
            localStorage.setItem('disney_wiki_settings', JSON.stringify(settings));
        });
    }

    function toggleSettings() {
        const modal = document.getElementById('settings-modal');
        modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
    }

    /* ================= ãƒšãƒ¼ã‚¸ç®¡ç†ãƒ»è¡¨ç¤º ================= */
    function renderPageList(filterText = '') {
        const list = document.getElementById('page-list');
        list.innerHTML = '';
        
        const terms = filterText.toLowerCase();

        pages.forEach(page => {
            // ã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã§æ¤œç´¢
            const matchTitle = page.title.toLowerCase().includes(terms);
            const matchSub = page.subtitle && page.subtitle.toLowerCase().includes(terms);

            if (matchTitle || matchSub) {
                const item = document.createElement('div');
                item.className = `page-item ${currentPageId === page.id ? 'active' : ''}`;
                item.innerHTML = `
                    <span onclick="openPage(${page.id})">${page.title}</span>
                    <button class="delete-btn" onclick="deletePage(${page.id})">Ã—</button>
                `;
                list.appendChild(item);
            }
        });
    }

    function searchWiki() {
        const text = document.getElementById('search-input').value;
        renderPageList(text);
    }

    function createNewPage() {
        const newId = Date.now();
        const newPage = {
            id: newId,
            title: 'æ–°è¦ãƒšãƒ¼ã‚¸',
            subtitle: '',
            content: 'ã“ã“ã«å†…å®¹ã‚’æ›¸ã„ã¦ãã ã•ã„...'
        };
        pages.push(newPage);
        saveData();
        renderPageList();
        openPage(newId);
    }

    function deletePage(id) {
        if(!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        pages = pages.filter(p => p.id !== id);
        saveData();
        renderPageList();
        if(currentPageId === id) {
            showTop();
        }
    }

    function openPage(id) {
        currentPageId = id;
        const page = pages.find(p => p.id === id);
        if (!page) return;

        document.getElementById('top-view').style.display = 'none';
        document.getElementById('editor-view').style.display = 'flex';
        
        document.getElementById('wiki-title').value = page.title;
        document.getElementById('wiki-subtitle').value = page.subtitle || '';
        document.getElementById('wiki-body').innerHTML = page.content;

        // ãƒªã‚¹ãƒˆã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¡¨ç¤ºæ›´æ–°
        renderPageList(document.getElementById('search-input').value);

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
        attachMediaEvents();
    }

    function showTop() {
        currentPageId = null;
        document.getElementById('top-view').style.display = 'block';
        document.getElementById('editor-view').style.display = 'none';
        renderPageList();
    }

    function saveCurrentPage() {
        if (!currentPageId) return;
        const page = pages.find(p => p.id === currentPageId);
        page.title = document.getElementById('wiki-title').value;
        page.subtitle = document.getElementById('wiki-subtitle').value;
        page.content = document.getElementById('wiki-body').innerHTML;
        saveData();
        renderPageList();
        
        // æ¼”å‡º
        if(settings.mickey) createMickeyEffect();
    }
    
    function updateCurrentTitle() {
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã—ãŸã‘ã‚Œã°ã“ã“ã§ãƒªã‚¹ãƒˆæ›´æ–°
        // renderPageList(); 
    }

    /* ================= ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ (ä¿®æ­£ç‰ˆ) ================= */
    
    // execCommandã¯deprecatedã§ã™ãŒã€å˜ç´”ãªå¤ªå­—ãƒ»æ–œä½“ã«ã¯ä¾ç„¶ã¨ã—ã¦æœ€ã‚‚ç¢ºå®Ÿã§ã™
    function execCmd(command, value = null) {
        document.execCommand(command, false, value);
        document.getElementById('wiki-body').focus();
    }

    // ãƒªãƒ³ã‚¯è¿½åŠ æ©Ÿèƒ½
    function addLink() {
        const url = prompt("ãƒªãƒ³ã‚¯å…ˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå¤–éƒ¨ã‚µã‚¤ãƒˆã¾ãŸã¯ãƒšãƒ¼ã‚¸IDï¼‰:", "http://");
        if (url) {
            // é¸æŠç¯„å›²ãŒã‚ã‚‹ã‹ç¢ºèª
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                document.execCommand('createLink', false, url);
                
                // æŒ¿å…¥ã•ã‚ŒãŸãƒªãƒ³ã‚¯ã«å¯¾ã—ã¦target="_blank"ãªã©ã‚’ä»˜ä¸ã—ãŸã„å ´åˆ
                // ã“ã®æ™‚ç‚¹ã§ã¯å˜ç´”ãªaã‚¿ã‚°ã«ãªã‚Šã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯æ™‚ã®æŒ™å‹•ã¯Globalã®ã‚¯ãƒªãƒƒã‚¯ãƒªã‚¹ãƒŠãƒ¼ã§åˆ¶å¾¡ã—ã¾ã™ã€‚
            }
        }
    }

    function insertImage() {
        const url = prompt("ç”»åƒã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "https://");
        if(url) {
            document.execCommand('insertImage', false, url);
            attachMediaEvents(); // æ–°ã—ã„ç”»åƒã«ã‚¤ãƒ™ãƒ³ãƒˆä»˜ä¸
        }
    }

    function insertPDFDemo() {
        // PDFã®ä»£ã‚ã‚Šã¨ãªã‚‹ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªã‚³ãƒ³ãƒ†ãƒŠã‚’æŒ¿å…¥
        const html = `
            <div class="pdf-container">
                <div class="pdf-content">
                    <h3>PDFãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ (ãƒ‡ãƒ¢)</h3>
                    <p>ã“ã“ã«é•·ã„æ–‡ç« ãŒã‚ã‚Šã¾ã™...</p>
                    <br><br><br><br><br>
                    <p>ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚ãƒãƒ¼ã‚«ãƒ¼ã¯è¿½å¾“ã—ã¾ã™ã€‚</p>
                    <div class="pdf-marker" style="top: 100px; left: 50px; width: 200px; height: 30px;" title="ãƒãƒ¼ã‚«ãƒ¼"></div>
                    <br><br><br><br><br><br><br><br>
                    <p>ãƒšãƒ¼ã‚¸ã®çµ‚ã‚ã‚Š</p>
                </div>
            </div>
        `;
        document.execCommand('insertHTML', false, html);
        attachMediaEvents();
    }

    // ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆWikiå†…é·ç§» or å¤–éƒ¨ï¼‰
    document.getElementById('wiki-body').addEventListener('click', function(e) {
        if (e.target.tagName === 'A') {
            const href = e.target.getAttribute('href');
            
            // å†…éƒ¨ãƒªãƒ³ã‚¯åˆ¤å®šï¼ˆç°¡æ˜“çš„ã«ãƒšãƒ¼ã‚¸IDã‹ã‚¿ã‚¤ãƒˆãƒ«ã§ã®ãƒãƒƒãƒãƒ³ã‚°ã‚’è©¦ã¿ã‚‹ï¼‰
            // è‡ªå‹•ãƒªãƒ³ã‚¯æ©Ÿèƒ½ã§ã¯ãƒšãƒ¼ã‚¸IDã‚’ href="#wiki-123" ã®ã‚ˆã†ã«å…¥ã‚Œã‚‹æƒ³å®š
            if(href.startsWith('#wiki-')) {
                e.preventDefault();
                const targetId = parseInt(href.replace('#wiki-', ''));
                openPage(targetId);
            } else {
                // å¤–éƒ¨ãƒªãƒ³ã‚¯ã¯åˆ¥ã‚¿ãƒ–ã§é–‹ã
                e.preventDefault();
                window.open(href, '_blank');
            }
        }
    });

    /* ================= ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ & æ‹¡å¤§ç¸®å°æ©Ÿèƒ½ ================= */

    let currentFocusScale = 1;
    let currentFocusX = 0;
    let currentFocusY = 0;

    function attachMediaEvents() {
        const body = document.getElementById('wiki-body');
        // ç”»åƒ
        const imgs = body.querySelectorAll('img');
        imgs.forEach(img => {
            img.onclick = (e) => {
                e.stopPropagation(); // ç·¨é›†ã‚­ãƒ£ãƒ¬ãƒƒãƒˆç§»å‹•ãªã©ã‚’é˜²ã
                enterFocusMode(img.cloneNode(true));
            };
        });
        
        // PDFã‚³ãƒ³ãƒ†ãƒŠ
        const pdfs = body.querySelectorAll('.pdf-container');
        pdfs.forEach(pdf => {
            // PDFã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã®ã¿
            pdf.onclick = (e) => {
                 // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯ãªã©ã§ãƒãƒ–ãƒªãƒ³ã‚°ã—ãŸå ´åˆã‚‚å«ã‚€
                e.stopPropagation();
                // ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã™ã‚‹ãŒã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¯ã‚³ãƒ”ãƒ¼ã•ã‚Œãªã„ã®ã§
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çŠ¶æ…‹ãªã©ã‚’ç¶­æŒã™ã‚‹ã®ã¯é›£ã—ã„ãŒã€ã“ã“ã§ã¯è¦‹ãŸç›®ã‚’ã‚³ãƒ”ãƒ¼
                const clone = pdf.cloneNode(true);
                // ã‚¯ãƒ­ãƒ¼ãƒ³å¾Œã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆé«˜ã•ã‚’ç”»é¢ã«åˆã‚ã›ã‚‹ç­‰ï¼‰
                clone.style.height = "80vh"; 
                clone.style.width = "80vw";
                enterFocusMode(clone);
            };
        });
    }

    function enterFocusMode(element) {
        const overlay = document.getElementById('focus-overlay');
        const contentArea = document.getElementById('focus-content-area');
        
        contentArea.innerHTML = '';
        contentArea.appendChild(element);
        
        // åˆæœŸåŒ–
        currentFocusScale = 1;
        currentFocusX = 0;
        currentFocusY = 0;
        updateFocusTransform();

        overlay.classList.add('active');
        
        // æ‹¡å¤§ç¸®å°æ“ä½œã®ãƒªã‚¹ãƒŠãƒ¼
        window.addEventListener('wheel', handleFocusWheel, { passive: false });
    }

    function closeFocus() {
        const overlay = document.getElementById('focus-overlay');
        overlay.classList.remove('active');
        window.removeEventListener('wheel', handleFocusWheel);
    }

    function handleFocusWheel(e) {
        if (!e.ctrlKey) return; // CtrlãŒãªã„å ´åˆã¯é€šå¸¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆPDFå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã©ï¼‰ã‚’è¨±å¯ã—ãŸã„ãŒâ€¦

        e.preventDefault(); // ãƒ–ãƒ©ã‚¦ã‚¶å…¨ä½“ã®ã‚ºãƒ¼ãƒ ã‚’é˜²ã

        const delta = e.deltaY * -0.01;
        const newScale = Math.min(Math.max(0.5, currentFocusScale + delta), 5); // 0.5å€ã€œ5å€åˆ¶é™

        currentFocusScale = newScale;
        updateFocusTransform();
    }

    function updateFocusTransform() {
        const wrapper = document.getElementById('focus-content-area');
        wrapper.style.transform = `scale(${currentFocusScale})`;
    }

    // ç·¨é›†ç”»é¢ã§PDFå†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãƒãƒ¼ã‚«ãƒ¼ãŒãšã‚Œãªã„ã®ã¯ã€
    // .pdf-container { position: relative; overflow: auto; }
    // .pdf-marker { position: absolute; }
    // ã®é–¢ä¿‚ã«ã‚ˆã‚Šã€ãƒãƒ¼ã‚«ãƒ¼ã¯ content ã®å­è¦ç´ ã§ã¯ãªã container ã®å­è¦ç´ ã ã¨ãšã‚Œã‚‹ã€‚
    // insertPDFDemoé–¢æ•°ã§ .pdf-content (relative) ã®ä¸­ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ä¸€ç·’ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã§è¦ä»¶ã¯æº€ãŸã›ã¾ã™ã€‚

    /* ================= è‡ªå‹•ãƒªãƒ³ã‚¯æ©Ÿèƒ½ (The Magic) ================= */
    
    function runAutoLinker() {
        if(!confirm('ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã«å¯¾ã—ã€ä»–ã®ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒå«ã¾ã‚Œã‚‹ç®‡æ‰€ã«ãƒªãƒ³ã‚¯ã‚’è²¼ã‚Šã¾ã™ã€‚\nã™ã§ã«ãƒªãƒ³ã‚¯ãŒã‚ã‚‹ç®‡æ‰€ã‚„è¦‹å‡ºã—ã¯é™¤å¤–ã•ã‚Œã¾ã™ã€‚\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;

        // 1. å…¨ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¾æ›¸åŒ–
        // { text: "ãƒŸãƒƒã‚­ãƒ¼", targetId: 1 }, { text: "ã‚¹ã‚¿ã‚¢", targetId: 1 } ...
        let keywords = [];
        pages.forEach(p => {
            // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«
            if(p.title) keywords.push({ text: p.title, id: p.id });
            // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«
            if(p.subtitle) {
                const subs = p.subtitle.split(/,|ã€/);
                subs.forEach(s => {
                    const trimmed = s.trim();
                    if(trimmed) keywords.push({ text: trimmed, id: p.id });
                });
            }
        });

        // é•·ã„å˜èªã‹ã‚‰å…ˆã«ãƒãƒƒãƒã•ã›ã‚‹ï¼ˆä¾‹ï¼šã€Œæ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã€ã‚’å…ˆã«ã€ã€Œæ±äº¬ã€ã‚’å¾Œã«ï¼‰
        keywords.sort((a, b) => b.text.length - a.text.length);

        // 2. å„ãƒšãƒ¼ã‚¸ã®ä¸­èº«ã‚’èµ°æŸ»ã—ã¦ç½®æ›
        let updateCount = 0;

        pages.forEach(page => {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = page.content;

            let modified = false;

            // TreeWalkerã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã®ã¿ã‚’èµ°æŸ»
            const walker = document.createTreeWalker(
                tempDiv,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // è¦ªè¦ç´ ãŒ Aã‚¿ã‚°, H1-H6, SCRIPT, STYLE ç­‰ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
                        const parent = node.parentNode;
                        const tag = parent.tagName;
                        if(['A', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'SCRIPT', 'STYLE', 'BUTTON'].includes(tag)) {
                            return NodeFilter.FILTER_REJECT;
                        }
                        return NodeFilter.FILTER_ACCEPT;
                    }
                }
            );

            let nodesToReplace = [];
            while(walker.nextNode()) {
                nodesToReplace.push(walker.currentNode);
            }

            // ãƒãƒ¼ãƒ‰ã”ã¨ã«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢
            nodesToReplace.forEach(node => {
                let text = node.nodeValue;
                let newHtml = text;
                let hasMatch = false;

                // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ—
                // æ³¨æ„: ä¸€åº¦ãƒªãƒ³ã‚¯ã«ã—ãŸç®‡æ‰€ã‚’äºŒé‡ãƒªãƒ³ã‚¯ã—ãªã„ã‚ˆã†ã«åˆ¶å¾¡ãŒå¿…è¦ã ãŒ
                // ç°¡æ˜“å®Ÿè£…ã¨ã—ã¦ã€ãƒ†ã‚­ã‚¹ãƒˆå…¨ä½“ã«å¯¾ã—ã¦replaceã‚’è¡Œã†
                // ãŸã ã—HTMLã‚¿ã‚°ã‚’å£Šã•ãªã„ã‚ˆã†ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãŒå¿…è¦
                
                // å˜ç´”ãªæ–‡å­—åˆ—ç½®æ›ã ã¨é›£ã—ã„ã®ã§ã€
                // ãƒãƒƒãƒã—ãŸç®‡æ‰€ã‚’ä¸€åº¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ã™ã‚‹ç­‰ã®å·¥å¤«ãŒå¿…è¦
                // ã“ã“ã§ã¯ä¸€ç•ªãƒãƒƒãƒã™ã‚‹é•·ã„å˜èª1ã¤ã ã‘ã‚’ãƒªãƒ³ã‚¯ã«ã™ã‚‹ç°¡æ˜“ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ¡ç”¨ã™ã‚‹ã‹ã€
                // ã‚ã‚‹ã„ã¯Regexã§ä¸€æ‹¬ç½®æ›ã™ã‚‹ã€‚
                
                // å¼·åŠ›ãªRegexç”Ÿæˆ: (Keyword1|Keyword2|...)
                // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
                const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                
                // è‡ªåˆ†è‡ªèº«ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ã¯ãƒªãƒ³ã‚¯ã—ãªã„
                const validKeywords = keywords.filter(k => k.id !== page.id);
                if(validKeywords.length === 0) return;

                const pattern = new RegExp(`(${validKeywords.map(k => escapeRegExp(k.text)).join('|')})`, 'g');

                if (pattern.test(text)) {
                    // ç½®æ›å®Ÿè¡Œ
                    // ãƒãƒƒãƒã—ãŸãƒ†ã‚­ã‚¹ãƒˆã«å¯¾å¿œã™ã‚‹IDã‚’è¦‹ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹
                    const replaced = text.replace(pattern, (match) => {
                        const k = validKeywords.find(vk => vk.text === match);
                        return `<a href="#wiki-${k.id}" style="color:#0056b3;">${match}</a>`;
                    });
                    
                    // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’HTMLè¦ç´ ï¼ˆspanãªã©ï¼‰ã«ç½®æ›
                    const span = document.createElement('span');
                    span.innerHTML = replaced;
                    node.parentNode.replaceChild(span, node);
                    modified = true;
                }
            });

            if(modified) {
                page.content = tempDiv.innerHTML;
                updateCount++;
            }
        });

        saveData();
        alert(`${updateCount} ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);
        
        // ç¾åœ¨é–‹ã„ã¦ã„ã‚‹ãƒšãƒ¼ã‚¸ãŒã‚ã‚Œã°ãƒªãƒ­ãƒ¼ãƒ‰
        if(currentPageId) {
            openPage(currentPageId);
        }
    }


    /* ================= æ¼”å‡º: ãƒŸãƒƒã‚­ãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ & èŠ±ç« ================= */
    
    function createMickeyEffect() {
        if(!settings.mickey) return;
        
        // ç”»é¢ä¸­å¤®ã‚ãŸã‚Šã‹ã‚‰å‡ºç¾
        const m = document.createElement('div');
        m.className = 'mickey-effect';
        // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®
        const x = Math.random() * window.innerWidth;
        const y = window.innerHeight - 50;
        
        m.style.left = x + 'px';
        m.style.top = y + 'px';
        
        document.body.appendChild(m);
        
        setTimeout(() => m.remove(), 2000);
    }

    // èŠ±ç«ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆCanvasï¼‰
    const canvas = document.getElementById('fireworks-container');
    const ctx = canvas.getContext('2d');
    let fireworks = [];
    
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function Particle(x, y, color) {
        this.x = x;
        this.y = y;
        this.color = color;
        const angle = Math.random() * Math.PI * 2;
        const speed = Math.random() * 3 + 1;
        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;
        this.life = 100;
        this.alpha = 1;
    }
    
    Particle.prototype.update = function() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.05; // gravity
        this.life--;
        this.alpha = this.life / 100;
    };
    
    Particle.prototype.draw = function(ctx) {
        ctx.save();
        ctx.globalAlpha = this.alpha;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    };

    function createFirework() {
        if(!settings.fireworks) return;
        const x = Math.random() * canvas.width;
        const y = Math.random() * (canvas.height / 2);
        const color = `hsl(${Math.random()*360}, 100%, 50%)`;
        
        for(let i=0; i<30; i++) {
            fireworks.push(new Particle(x, y, color));
        }
    }

    function fireworksLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if(settings.fireworks && Math.random() < 0.02) { // ç¢ºç‡ã§æ‰“ã¡ä¸Šã’
            createFirework();
        }

        for(let i = fireworks.length - 1; i >= 0; i--) {
            fireworks[i].update();
            fireworks[i].draw(ctx);
            if(fireworks[i].life <= 0) {
                fireworks.splice(i, 1);
            }
        }
        
        requestAnimationFrame(fireworksLoop);
    }

</script>
</body>
</html>
