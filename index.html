<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨æ´»å‹•ãƒã‚¹ã‚¿ãƒ¼ä½œæˆãƒ„ãƒ¼ãƒ«ï¼ˆä¿å­˜ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿è­·å¯¾å¿œç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        /* ãƒ¡ã‚¤ãƒ³ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .workspace {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* ç·¨é›†ãƒ‘ãƒãƒ«ï¼ˆå·¦å´ï¼‰ */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 300px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }

        .control-group h3 {
            margin-top: 0;
            font-size: 16px;
            color: #555;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input[type="text"], textarea, select, input[type="number"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 5px;
            transition: background 0.2s;
        }

        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        
        button:hover { opacity: 0.9; }

        /* ãƒã‚¹ã‚¿ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå³å´ï¼‰ */
        #poster-container {
            position: relative;
            width: 600px; /* A4æ¯”ç‡ãªã©ã‚’æƒ³å®š */
            height: 848px;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
        }

        /* èƒŒæ™¯ç”»åƒã‚„ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #poster-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* è¦ç´ ã‚’é…ç½®ã™ã‚‹ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #poster-elements {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªè¦ç´ ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .draggable-item {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 1px dashed transparent;
        }
        .draggable-item:hover {
            border: 1px dashed #aaa;
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆè¦ç´  */
        .poster-text {
            white-space: pre-wrap;
            padding: 5px;
        }

        /* ãƒŸãƒƒã‚­ãƒ¼ã‚·ãƒ«ã‚¨ãƒƒãƒˆ */
        .mickey-shape {
            pointer-events: none; /* ä¸‹ã®æ–‡å­—ã‚’é¸æŠã§ãã‚‹ã‚ˆã†ã« */
        }

        /* è¡¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .poster-table {
            border-collapse: collapse;
            background: white;
            font-size: 14px;
            width: 100%;
        }
        .poster-table th, .poster-table td {
            border: 1px solid #333;
            padding: 8px;
            text-align: center;
        }
        .poster-table th {
            background-color: #f0f0f0;
        }

        /* æ™‚ç³»åˆ—ï¼ˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .poster-timeline {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-left: 4px solid #007bff;
        }
        .timeline-item {
            margin-bottom: 5px;
            font-size: 14px;
        }
        .timeline-time {
            font-weight: bold;
            color: #007bff;
            margin-right: 5px;
        }

    </style>
</head>
<body>

    <h1>éƒ¨æ´»ãƒã‚¹ã‚¿ãƒ¼ä½œæˆ</h1>

    <div class="workspace">
        <div class="controls">
            
            <div class="control-group">
                <h3>ğŸ’¾ ä¿å­˜ã¨ãƒªã‚»ãƒƒãƒˆ</h3>
                <p style="font-size:12px; color:#666;">â€»è¡¨ã‚„æ™‚ç³»åˆ—ã‚‚å«ã‚ã¦ç”»åƒä¿å­˜ã•ã‚Œã¾ã™</p>
                <button onclick="downloadPoster()" class="btn-success">ç”»åƒã‚’ä¿å­˜ã™ã‚‹</button>
                <button onclick="saveProjectData()" class="btn-primary">ä¸€æ™‚ä¿å­˜ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰</button>
                <button onclick="resetProject()" class="btn-danger">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div class="control-group">
                <h3>ğŸ“ æ–‡å­—ã‚’è¿½åŠ </h3>
                <input type="text" id="TextInput" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›">
                <input type="color" id="TextColor" value="#000000">
                <label>ã‚µã‚¤ã‚º: <input type="number" id="TextSize" value="24" style="width:60px;"></label>
                <button onclick="addText()" class="btn-secondary">æ–‡å­—ã‚’è¿½åŠ </button>
            </div>

            <div class="control-group">
                <h3>ğŸ­ ãƒŸãƒƒã‚­ãƒ¼æ¼”å‡º</h3>
                <label>ä¸é€æ˜åº¦: <input type="range" id="MickeyOpacity" min="0" max="1" step="0.1" value="1"></label>
                <button onclick="addMickey()" class="btn-secondary">ãƒŸãƒƒã‚­ãƒ¼ã‚’è¿½åŠ </button>
            </div>

            <div class="control-group">
                <h3>ğŸ“Š è¡¨ã‚’è¿½åŠ </h3>
                <textarea id="TableData" rows="3" placeholder="é …ç›®1,å†…å®¹1&#13;é …ç›®2,å†…å®¹2&#13;é …ç›®3,å†…å®¹3"></textarea>
                <button onclick="addTable()" class="btn-secondary">è¡¨ã‚’è¿½åŠ </button>
            </div>

            <div class="control-group">
                <h3>ğŸ•’ æ™‚ç³»åˆ—ã‚’è¿½åŠ </h3>
                <textarea id="TimelineData" rows="3" placeholder="9:00,é›†åˆ&#13;10:00,ç·´ç¿’é–‹å§‹&#13;12:00,æ˜¼ä¼‘æ†©"></textarea>
                <button onclick="addTimeline()" class="btn-secondary">æ™‚ç³»åˆ—ã‚’è¿½åŠ </button>
            </div>
            
            <div class="control-group">
                <p style="font-size:12px; color:red;">â€»è¦ç´ ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤</p>
            </div>
        </div>

        <div id="poster-container">
            <div id="poster-bg" style="background-color: white;"></div>
            <div id="poster-elements"></div>
        </div>
    </div>

<script>
    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    
    // åˆæœŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ™‚ã«ã“ã“ãŒå¤‰ã‚ã£ã¦ã‚‚ã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆãªã„ã‚ˆã†ã«ãƒãƒ¼ã‚¸ã—ã¾ã™ï¼‰
    const defaultData = {
        elements: [] // ãƒ†ã‚­ã‚¹ãƒˆã€è¡¨ã€ã‚¹ã‚¿ãƒ³ãƒ—ãªã©ã®å…¨è¦ç´ 
    };

    let currentData = JSON.parse(JSON.stringify(defaultData));

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
    window.onload = function() {
        loadProjectData();
    };

    // --- æ©Ÿèƒ½å®Ÿè£… ---

    // 1. æ–‡å­—ã®è¿½åŠ 
    function addText() {
        const text = document.getElementById('TextInput').value;
        if (!text) return;
        const color = document.getElementById('TextColor').value;
        const size = document.getElementById('TextSize').value;

        const element = {
            id: Date.now(),
            type: 'text',
            content: text,
            x: 50,
            y: 50,
            style: { color: color, fontSize: size + 'px', fontWeight: 'bold' }
        };
        currentData.elements.push(element);
        renderElements();
    }

    // 2. ãƒŸãƒƒã‚­ãƒ¼ã®è¿½åŠ ï¼ˆã‚³ãƒ¼ãƒ‰ã§æç”»ã™ã‚‹ã®ã§ç”»åƒä¸è¦ãƒ»èƒŒæ™¯é€æ˜ãƒ»ä¸­èº«ä¸é€æ˜ï¼‰
    function addMickey() {
        const opacity = document.getElementById('MickeyOpacity').value;
        
        const element = {
            id: Date.now(),
            type: 'mickey',
            x: 200,
            y: 200,
            scale: 1,
            opacity: opacity
        };
        currentData.elements.push(element);
        renderElements();
    }

    // 3. è¡¨ã®è¿½åŠ 
    function addTable() {
        const raw = document.getElementById('TableData').value;
        if (!raw) return;

        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚ŠCSVã‚’é…åˆ—ã«å¤‰æ›
        const rows = raw.split('\n').map(r => r.split(','));

        const element = {
            id: Date.now(),
            type: 'table',
            content: rows,
            x: 50,
            y: 150
        };
        currentData.elements.push(element);
        renderElements();
    }

    // 4. æ™‚ç³»åˆ—ã®è¿½åŠ 
    function addTimeline() {
        const raw = document.getElementById('TimelineData').value;
        if (!raw) return;

        const rows = raw.split('\n').map(r => r.split(','));

        const element = {
            id: Date.now(),
            type: 'timeline',
            content: rows, // [time, event]
            x: 50,
            y: 300
        };
        currentData.elements.push(element);
        renderElements();
    }

    // --- æç”»ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‡¦ç† ---

    function renderElements() {
        const container = document.getElementById('poster-elements');
        container.innerHTML = ''; // ä¸€æ—¦ã‚¯ãƒªã‚¢

        currentData.elements.forEach(el => {
            const div = document.createElement('div');
            div.className = 'draggable-item';
            div.style.left = el.x + 'px';
            div.style.top = el.y + 'px';
            
            // ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ã®ä»˜ä¸
            makeDraggable(div, el.id);
            // å‰Šé™¤æ©Ÿèƒ½ï¼ˆãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ï¼‰
            div.ondblclick = () => removeElement(el.id);

            // ã‚¿ã‚¤ãƒ—åˆ¥ã®æç”»å†…å®¹
            if (el.type === 'text') {
                div.innerHTML = `<div class="poster-text" style="color:${el.style.color}; font-size:${el.style.fontSize}; font-weight:${el.style.fontWeight};">${el.content}</div>`;
            } 
            else if (el.type === 'mickey') {
                // SVGã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚³ãƒ¼ãƒ‰ã§ç¶ºéº—ãªãƒŸãƒƒã‚­ãƒ¼ã‚’æã
                // ä¸­ã¯é»’å¡—ã‚Šï¼ˆä¸é€æ˜ï¼‰ã€å‘¨ã‚Šã¯é€æ˜
                const size = 150;
                const svg = `
                <svg width="${size}" height="${size}" viewBox="0 0 200 200" style="opacity:${el.opacity};">
                    <circle cx="50" cy="50" r="40" fill="black" />
                    <circle cx="150" cy="50" r="40" fill="black" />
                    <circle cx="100" cy="110" r="60" fill="black" />
                </svg>`;
                div.innerHTML = svg;
                div.className += ' mickey-shape'; // ãƒã‚¤ãƒ³ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆé€éç”¨ã‚¯ãƒ©ã‚¹
            }
            else if (el.type === 'table') {
                let html = '<table class="poster-table">';
                el.content.forEach((row, i) => {
                    html += '<tr>';
                    row.forEach(cell => {
                        html += i === 0 ? `<th>${cell}</th>` : `<td>${cell}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</table>';
                div.innerHTML = html;
            }
            else if (el.type === 'timeline') {
                let html = '<div class="poster-timeline">';
                el.content.forEach(item => {
                    if(item.length >= 2) {
                        html += `<div class="timeline-item"><span class="timeline-time">${item[0]}</span> ${item[1]}</div>`;
                    }
                });
                html += '</div>';
                div.innerHTML = html;
            }

            container.appendChild(div);
        });
    }

    // è¦ç´ ã®å‰Šé™¤
    function removeElement(id) {
        if(confirm('ã“ã®è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            currentData.elements = currentData.elements.filter(el => el.id !== id);
            renderElements();
            saveProjectData(); // å‰Šé™¤ã‚‚ä¿å­˜
        }
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°ç§»å‹•ã®ãƒ­ã‚¸ãƒƒã‚¯ ---
    function makeDraggable(element, id) {
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        element.onmousedown = function(e) {
            e.preventDefault();
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = element.offsetLeft;
            initialTop = element.offsetTop;

            document.onmousemove = function(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                element.style.left = (initialLeft + dx) + 'px';
                element.style.top = (initialTop + dy) + 'px';
            };

            document.onmouseup = function() {
                isDragging = false;
                document.onmousemove = null;
                document.onmouseup = null;
                
                // ä½ç½®æƒ…å ±ã‚’ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¦ä¿å­˜
                const target = currentData.elements.find(el => el.id === id);
                if(target) {
                    target.x = parseInt(element.style.left);
                    target.y = parseInt(element.style.top);
                    saveProjectData(); // è‡ªå‹•ä¿å­˜
                }
            };
        };
    }

    // --- ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿æ©Ÿèƒ½ï¼ˆé‡è¦ï¼šãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±é˜²æ­¢å¯¾å¿œï¼‰ ---

    function saveProjectData() {
        // localStorageã«JSONã¨ã—ã¦ä¿å­˜
        localStorage.setItem('clubPosterData_v2', JSON.stringify(currentData));
    }

    function loadProjectData() {
        const saved = localStorage.getItem('clubPosterData_v2');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                
                // ã€é‡è¦ã€‘ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒ¼ã‚¸å‡¦ç†
                // ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«æ–°ã—ã„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒè¿½åŠ ã•ã‚Œã¦ã‚‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ã‚ˆã†
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã¨çµåˆã—ã¾ã™ã€‚
                
                // 1. é…åˆ—ã§ãªã„å ´åˆã¯åˆæœŸåŒ–ï¼ˆå¿µã®ãŸã‚ï¼‰
                if (!Array.isArray(parsed.elements)) {
                    parsed.elements = [];
                }

                // 2. æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†
                currentData = parsed;
                
                // 3. ç”»é¢ã«åæ˜ 
                renderElements();
            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åˆæœŸçŠ¶æ…‹ã§é–‹å§‹ï¼ˆå®‰å…¨ç­–ï¼‰
            }
        }
    }

    function resetProject() {
        if(confirm('å…¨ã¦ã®ç·¨é›†å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
            currentData = JSON.parse(JSON.stringify(defaultData));
            renderElements();
            localStorage.removeItem('clubPosterData_v2');
        }
    }

    // --- ç”»åƒã¨ã—ã¦æ›¸ãå‡ºã—ï¼ˆè¡¨ã‚„æ™‚ç³»åˆ—ã‚‚å«ã‚€ï¼‰ ---
    function downloadPoster() {
        const poster = document.getElementById('poster-container');
        
        // html2canvasã‚’ä½¿ã£ã¦ã€è¦‹ãŸç›®ãã®ã¾ã¾ã‚’ç”»åƒåŒ–
        html2canvas(poster, {
            scale: 2, // é«˜ç”»è³ªè¨­å®š
            useCORS: true, // ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼é˜²æ­¢
            backgroundColor: null // èƒŒæ™¯é€æ˜åº¦ç¶­æŒ
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = 'éƒ¨æ´»ãƒã‚¹ã‚¿ãƒ¼.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).catch(err => {
            alert('ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n' + err);
        });
    }

</script>
</body>
</html>
