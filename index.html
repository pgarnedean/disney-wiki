<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Wiki - Royal Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- 1. ÂÖÉ„ÅÆ„Éá„Ç∂„Ç§„É≥ÔºàDisney„ÉÜ„Éº„ÉûÔºâ --- */
        :root {
            --disney-blue: #1e366e;
            --disney-gold: #c5a059;
            --wiki-border: #a2a9b1;
            --bg-color: #f4f5f7;
        }

        body {
            font-family: 'Noto Serif JP', serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; color: #202122;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            background: linear-gradient(135deg, var(--disney-blue), #0d1b38);
            color: white; padding: 10px 30px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--disney-gold);
            position: sticky; top: 0; z-index: 1000;
        }

        .logo {
            font-family: 'Cinzel', serif; font-size: 26px; font-weight: bold;
            color: var(--disney-gold); cursor: pointer; text-decoration: none;
        }

        /* Ê§úÁ¥¢„Éê„Éº */
        .search-box {
            position: relative; width: 300px;
        }
        .search-box input {
            width: 100%; padding: 8px 35px 8px 15px; border-radius: 20px;
            border: 1px solid var(--disney-gold); outline: none;
        }
        .search-box i {
            position: absolute; right: 12px; top: 10px; color: var(--disney-blue);
        }

        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        .container {
            display: flex; max-width: 1400px; margin: 20px auto;
            background: white; min-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* „Çµ„Ç§„Éâ„Éê„ÉºÔºàÁõÆÊ¨°Ôºâ */
        .sidebar {
            width: 280px; padding: 20px; background: #fbfbfb; border-right: 1px solid #eee;
        }
        .toc-title { font-weight: bold; border-bottom: 1px solid var(--disney-gold); margin-bottom: 10px; }
        .toc-list { list-style: none; padding: 0; font-size: 14px; }
        .toc-item { margin: 5px 0; position: relative; padding-left: 20px; }
        .toc-toggle { 
            position: absolute; left: 0; cursor: pointer; transition: 0.3s;
            color: var(--disney-gold);
        }
        .toc-sub { padding-left: 15px; display: block; }
        .collapsed .toc-sub { display: none; }
        .collapsed .toc-toggle { transform: rotate(-90deg); }
        .toc-link { color: #0645ad; text-decoration: none; }

        /* „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ */
        .main-content { flex: 1; padding: 40px; position: relative; }

        /* --- 2. Á∑®ÈõÜ„ÉÑ„Éº„É´„Éê„ÉºÔºàWikipediaÈ¢®Ôºâ --- */
        .editor-toolbar {
            background: #f8f9fa; border: 1px solid var(--wiki-border);
            padding: 5px; display: flex; gap: 3px; flex-wrap: wrap;
            position: sticky; top: 60px; z-index: 999; margin-bottom: 20px;
        }
        .t-btn {
            background: white; border: 1px solid #ccc; padding: 5px 8px;
            cursor: pointer; font-size: 12px; min-width: 30px;
        }
        .t-btn:hover { background: #e0e0e0; }
        .t-sep { width: 1px; background: #ccc; margin: 0 5px; }

        /* Ë®ò‰∫ãË¶ÅÁ¥† */
        h1.page-title { font-family: 'Cinzel', serif; border-bottom: 1px solid #aaa; font-size: 2.5em; margin-top: 0; }
        h2 { border-bottom: 1px solid #aaa; color: var(--disney-blue); margin-top: 30px; }
        h3 { color: var(--disney-blue); margin-top: 20px; }
        
        /* „Ç§„É≥„Éï„Ç©„Éú„ÉÉ„ÇØ„Çπ */
        .infobox {
            float: right; width: 300px; border: 1px solid #aaa;
            background: #fff; margin: 0 0 20px 20px; padding: 5px; font-size: 90%;
        }
        .infobox-head { background: var(--disney-blue); color: white; text-align: center; padding: 8px; font-weight: bold; }
        .infobox table { width: 100%; border-collapse: collapse; }
        .infobox th { background: #f2f2f2; text-align: left; padding: 5px; width: 35%; border-bottom: 1px solid #eee; }
        .infobox td { padding: 5px; border-bottom: 1px solid #eee; }

        /* TOP„Éö„Éº„Ç∏Áî®„Ç´„Éº„Éâ */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; transition: 0.3s; cursor: pointer; }
        .page-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .card-img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; text-align: center; font-family: 'Cinzel', serif; font-weight: bold; color: var(--disney-blue); }

        /* Á∑®ÈõÜ„Ç®„É™„Ç¢ */
        .edit-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fffdf5; }
        textarea { width: 100%; min-height: 120px; border: 1px solid #ccc; font-family: monospace; padding: 10px; }
        
        .btn-royal {
            background: var(--disney-blue); color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.router('home')">‚ú® Disney Wiki</div>
        <div class="search-box">
            <input type="text" id="search-input" placeholder="WikiÂÜÖ„ÇíÊ§úÁ¥¢..." onkeypress="if(event.key==='Enter') app.search()">
            <i class="fas fa-search"></i>
        </div>
        <button id="auth-btn" class="btn-royal" style="background: var(--disney-gold); color: #000;">„É≠„Ç∞„Ç§„É≥</button>
    </header>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="toc-title">ÂÜÖÂÆπ / ÁõÆÊ¨°</div>
            <ul class="toc-list" id="toc-list"></ul>
            <div style="margin-top:40px;">
                <button onclick="app.createNewPage()" style="cursor:pointer; border:1px dashed var(--disney-gold); padding:5px; background:none; width:100%;">+ Êñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàê</button>
            </div>
        </aside>

        <main class="main-content">
            <div id="view-mode">
                <div id="page-content"></div>
                <div style="margin-top: 50px; text-align: right;">
                    <button class="btn-royal" id="edit-start-btn" onclick="app.toggleEdit()">„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÁ∑®ÈõÜ„Åô„Çã ‚úé</button>
                </div>
            </div>

            <div id="edit-mode" class="hidden">
                <h1 id="edit-title-name">Á∑®ÈõÜÔºö</h1>
                
                <div class="editor-toolbar">
                    <button class="t-btn" onclick="editor.insert('**','**')" title="Â§™Â≠ó"><b>B</b></button>
                    <button class="t-btn" onclick="editor.insert('*','*')" title="Êñú‰Ωì"><i>I</i></button>
                    <button class="t-btn" onclick="editor.insert('<u>','</u>')" title="‰∏ãÁ∑ö"><u>U</u></button>
                    <button class="t-btn" onclick="editor.insert('~~','~~')" title="Âèñ„ÇäÊ∂à„ÅóÁ∑ö"><s>S</s></button>
                    <button class="t-btn" onclick="editor.insert('<sup>','</sup>')" title="‰∏ä‰ªò„Åç">x¬≤</button>
                    <button class="t-btn" onclick="editor.insert('<sub>','</sub>')" title="‰∏ã‰ªò„Åç">x‚ÇÇ</button>
                    <div class="t-sep"></div>
                    <button class="t-btn" onclick="editor.insert('<span style=\'font-size:1.5em\'>','</span>')" title="Â§ß„Åç„Åè">Â§ß</button>
                    <button class="t-btn" onclick="editor.insert('<span style=\'font-size:0.8em\'>','</span>')" title="Â∞è„Åï„Åè">Â∞è</button>
                    <div class="t-sep"></div>
                    <button class="t-btn" onclick="editor.insert('[[',']]')" title="ÂÜÖÈÉ®„É™„É≥„ÇØ"><i class="fas fa-link"></i> WikiÂÜÖ</button>
                    <button class="t-btn" onclick="editor.insert('https://en.wiktionary.org/wiki/%E5%90%8D%E5%89%8D')" title="Â§ñÈÉ®„É™„É≥„ÇØ"><i class="fas fa-external-link-alt"></i> Â§ñÈÉ®</button>
                    <div class="t-sep"></div>
                    <button class="t-btn" onclick="editor.insert('[[Image:',']]')" title="ÁîªÂÉèÊåøÂÖ•"><i class="fas fa-image"></i> ÁîªÂÉè/GIF</button>
                    <button class="t-btn" onclick="editor.insert('[[Video:',']]')" title="ÂãïÁîªÊåøÂÖ•"><i class="fas fa-video"></i> ÂãïÁîª</button>
                    <button class="t-btn" onclick="editor.insertTable()" title="Ë°®ÊåøÂÖ•"><i class="fas fa-table"></i> Ë°®</button>
                    <div class="t-sep"></div>
                    <button class="t-btn" onclick="app.savePage()" style="background: var(--disney-gold); font-weight: bold;">‚ú® È≠îÊ≥ï„Çí‰øùÂ≠ò</button>
                    <button class="t-btn" onclick="app.toggleEdit()">Êàª„Çã</button>
                </div>

                <div id="editor-sections"></div>
                <button onclick="editor.addSection()" class="t-btn" style="width:100%; padding:10px;">+ „Çª„ÇØ„Ç∑„Éß„É≥„ÇíËøΩÂä†</button>

                <div id="home-config" class="hidden" style="margin-top:30px; padding:20px; border:2px solid var(--disney-gold);">
                    <h3>üè† „Éà„ÉÉ„Éó„Éö„Éº„Ç∏Ë®≠ÂÆö</h3>
                    <p>Ë°®Á§∫„Åó„Åü„ÅÑ„Éö„Éº„Ç∏„ÅÆID„Çí„Ç´„É≥„Éû„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                    <input type="text" id="home-featured-ids" style="width:100%; padding:10px;" placeholder="Mickey, TDL, TDS">
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Ë®≠ÂÆöÔºö„É¶„Éº„Ç∂„ÉºÊèê‰æõ„ÅÆ„ÇÇ„ÅÆ„Çí‰ΩøÁî®
        const firebaseConfig = {
            apiKey: "AIzaSyBXGAvYQnGZGIALlfsE93C4vBMR41Lp6QA",
            authDomain: "disney-wiki-b76e8.firebaseapp.com",
            projectId: "disney-wiki-b76e8",
            storageBucket: "disney-wiki-b76e8.firebasestorage.app",
            messagingSenderId: "929516211078",
            appId: "1:929516211078:web:a9c5b3a32a9a9c089e3a07"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const provider = new GoogleAuthProvider();

        window.app = {
            currentPageId: 'home',
            currentUser: null,
            data: {},

            init: function() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    document.getElementById('auth-btn').textContent = user ? '„É≠„Ç∞„Ç¢„Ç¶„Éà' : '„É≠„Ç∞„Ç§„É≥';
                    document.getElementById('auth-btn').onclick = () => user ? signOut(auth) : signInWithPopup(auth, provider);
                });
                window.addEventListener('hashchange', () => this.router());
                this.router();
            },

            router: function() {
                const hash = decodeURIComponent(window.location.hash.replace('#', '')) || 'home';
                this.currentPageId = hash;
                this.loadPage(hash);
            },

            loadPage: async function(id) {
                const snap = await getDoc(doc(db, "pages", id));
                if (snap.exists()) {
                    this.data = snap.data();
                } else {
                    this.data = { title: id, sections: [], infobox: { image:'', rows:[] }, featured: [] };
                }
                this.render();
            },

            render: function() {
                const isHome = this.currentPageId === 'home';
                document.getElementById('sidebar').style.display = isHome ? 'none' : 'block';
                const container = document.getElementById('page-content');
                container.innerHTML = `<h1 class="page-title">${this.data.title}</h1>`;

                if (isHome) {
                    this.renderHome(container);
                } else {
                    this.renderWiki(container);
                }
            },

            renderWiki: function(container) {
                // Infobox
                if(this.data.infobox.image || this.data.infobox.rows.length) {
                    let ib = `<div class="infobox"><div class="infobox-head">${this.data.title}</div>`;
                    if(this.data.infobox.image) ib += `<img src="${this.data.infobox.image}" style="width:100%">`;
                    ib += `<table>`;
                    this.data.infobox.rows.forEach(r => ib += `<tr><th>${r.key}</th><td>${r.value}</td></tr>`);
                    ib += `</table></div>`;
                    container.innerHTML += ib;
                }

                // Sections & TOC
                const tocList = document.getElementById('toc-list');
                tocList.innerHTML = '';
                
                this.data.sections.forEach((sec, i) => {
                    const tag = sec.level == 3 ? 'h3' : 'h2';
                    container.innerHTML += `<${tag} id="sec-${i}">${sec.heading}</${tag}>`;
                    container.innerHTML += `<div>${this.parse(sec.content)}</div>`;

                    // TOC logic
                    if(sec.level == 2) {
                        const li = document.createElement('li');
                        li.className = 'toc-item';
                        li.innerHTML = `<a href="#sec-${i}" class="toc-link">${sec.heading}</a>`;
                        
                        // Check for children
                        const subUl = document.createElement('ul');
                        subUl.className = 'toc-sub';
                        let hasChild = false;
                        for(let j=i+1; j<this.data.sections.length; j++) {
                            if(this.data.sections[j].level == 3) {
                                hasChild = true;
                                subUl.innerHTML += `<li class="toc-item"><a href="#sec-${j}" class="toc-link">${this.data.sections[j].heading}</a></li>`;
                            } else break;
                        }
                        if(hasChild) {
                            li.classList.add('collapsed');
                            const toggle = document.createElement('span');
                            toggle.className = 'toc-toggle';
                            toggle.innerHTML = '<i class="fas fa-caret-down"></i>';
                            toggle.onclick = (e) => { e.preventDefault(); li.classList.toggle('collapsed'); };
                            li.prepend(toggle);
                            li.appendChild(subUl);
                        }
                        tocList.appendChild(li);
                    }
                });
            },

            renderHome: async function(container) {
                container.innerHTML += `<p>Disney Wiki „Å∏„Çà„ÅÜ„Åì„ÅùÔºÅÈ≠îÊ≥ï„ÅÆ„Çà„ÅÜ„Å™ÁôæÁßë‰∫ãÂÖ∏„Çí„Åø„Çì„Å™„Åß‰Ωú„Çä„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>`;
                const grid = document.createElement('div');
                grid.className = 'home-grid';
                for(const id of (this.data.featured || [])) {
                    const s = await getDoc(doc(db, "pages", id.trim()));
                    if(s.exists()){
                        const d = s.data();
                        grid.innerHTML += `
                            <div class="page-card" onclick="location.hash='${id.trim()}'">
                                <img src="${d.infobox.image}" class="card-img">
                                <div class="card-body">${d.title}</div>
                            </div>`;
                    }
                }
                container.appendChild(grid);
            },

            parse: function(t) {
                if(!t) return '';
                return t
                    .replace(/\*\* (.*?) \*\*/g, '<b>$1</b>')
                    .replace(/\* (.*?) \*/g, '<i>$1</i>')
                    .replace(/\[\[Image:(.*?)\]\]/g, '<img src="$1" style="max-width:100%; border:1px solid #ccc; padding:2px;">')
                    .replace(/\[\[Video:(.*?)\]\]/g, '<video src="$1" controls style="max-width:100%"></video>')
                    .replace(/\[\[(.*?)\]\]/g, '<a href="#$1" style="color:#0645ad">$1</a>')
                    .replace(/\[(https?:\/\/\S+)\s(.*?)\]/g, '<a href="$1" target="_blank" style="color:#36b">$2 <i class="fas fa-external-link-alt" style="font-size:10px"></i></a>')
                    .replace(/\{\|([\s\S]*?)\|\}/g, (m, content) => {
                        let html = '<table border="1" style="width:100%; border-collapse:collapse;">';
                        content.split('|-').forEach(row => {
                            html += '<tr>' + row.split('|').filter(c=>c.trim()).map(c => `<td>${c}</td>`).join('') + '</tr>';
                        });
                        return html + '</table>';
                    })
                    .replace(/\n/g, '<br>');
            },

            toggleEdit: function() {
                if(!this.currentUser) return alert('Á∑®ÈõÜ„Å´„ÅØ„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                document.getElementById('view-mode').classList.toggle('hidden');
                document.getElementById('edit-mode').classList.toggle('hidden');
                if(!document.getElementById('edit-mode').classList.contains('hidden')) editor.load();
            },

            savePage: async function() {
                const updated = editor.save();
                await setDoc(doc(db, "pages", this.currentPageId), updated);
                location.reload();
            },

            search: function() {
                const v = document.getElementById('search-input').value;
                if(v) location.hash = v;
            },

            createNewPage: function() {
                const n = prompt("Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                if(n) location.hash = n;
            }
        };

        window.editor = {
            load: function() {
                document.getElementById('edit-title-name').textContent = "Á∑®ÈõÜÔºö" + app.data.title;
                const list = document.getElementById('editor-sections');
                list.innerHTML = `
                    <div class="edit-section">
                        <h4>„Ç§„É≥„Éï„Ç©„Éú„ÉÉ„ÇØ„Çπ (ÁîªÂÉèURL / È†ÖÁõÆ)</h4>
                        ÁîªÂÉè: <input type="text" id="e-ib-img" value="${app.data.infobox.image}" style="width:80%"><br>
                        È†ÖÁõÆ(Key:Value, „Ç´„É≥„ÉûÂå∫Âàá„Çä): <textarea id="e-ib-rows">${app.data.infobox.rows.map(r=>`${r.key}:${r.value}`).join(',')}</textarea>
                    </div>`;
                app.data.sections.forEach(s => this.addSection(s));
                
                if(app.currentPageId === 'home') {
                    document.getElementById('home-config').classList.remove('hidden');
                    document.getElementById('home-featured-ids').value = app.data.featured.join(',');
                } else {
                    document.getElementById('home-config').classList.add('hidden');
                }
            },

            addSection: function(s = {heading:'', content:'', level:2}) {
                const d = document.createElement('div');
                d.className = 'edit-section';
                d.innerHTML = `
                    Ë¶ãÂá∫„Åó„É¨„Éô„É´: <select class="e-level"><option value="2" ${s.level==2?'selected':''}>H2</option><option value="3" ${s.level==3?'selected':''}>H3 (Â∞èË¶ãÂá∫„Åó)</option></select>
                    Ë¶ãÂá∫„ÅóÂêç: <input type="text" class="e-head" value="${s.heading}" style="width:60%">
                    <button onclick="this.parentElement.remove()">ÂâäÈô§</button>
                    <textarea class="e-content">${s.content}</textarea>
                `;
                document.getElementById('editor-sections').appendChild(d);
            },

            insert: function(b, a) {
                const el = document.activeElement;
                if(el.tagName === 'TEXTAREA') {
                    const s = el.selectionStart;
                    const e = el.selectionEnd;
                    el.value = el.value.substring(0, s) + b + el.value.substring(s, e) + a + el.value.substring(e);
                }
            },

            insertTable: function() {
                this.insert("\n{| \n|- \n| Ë¶ãÂá∫„Åó1 | Ë¶ãÂá∫„Åó2 \n|- \n| „Éá„Éº„Çø1 | „Éá„Éº„Çø2 \n|}", "");
            },

            save: function() {
                const secs = [];
                document.querySelectorAll('#editor-sections > .edit-section').forEach(el => {
                    const h = el.querySelector('.e-head')?.value;
                    if(h !== undefined) {
                        secs.push({
                            level: el.querySelector('.e-level').value,
                            heading: h,
                            content: el.querySelector('.e-content').value
                        });
                    }
                });
                const ibRows = document.getElementById('e-ib-rows').value.split(',').filter(r=>r.includes(':')).map(r => {
                    const parts = r.split(':');
                    return { key: parts[0].trim(), value: parts[1].trim() };
                });
                return {
                    title: app.data.title,
                    sections: secs,
                    infobox: { image: document.getElementById('e-ib-img').value, rows: ibRows },
                    featured: document.getElementById('home-featured-ids')?.value.split(',') || []
                };
            }
        };

        app.init();
    </script>
</body>
</html>
