<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Wiki - Royal Magical Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --disney-blue: #1e366e;
            --disney-gold: #c5a059;
            --bg-color: #f4f5f7;
        }

        body { 
            font-family: 'Noto Serif JP', serif; 
            background-color: var(--bg-color); 
            margin: 0; 
            color: #202122; 
            position: relative; 
            overflow-x: hidden; 
        }
        body.noscroll { overflow: hidden; }

        /* --- æ¼”å‡ºé–¢é€£ --- */
        #effects-canvas, #fireworks-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
        }
        #effects-canvas { z-index: 9990; }
        #fireworks-canvas { z-index: 9995; }

        .sparkle-cross {
            position: absolute; width: 20px; height: 20px;
            background: radial-gradient(circle, rgba(255,255,255,1) 10%, rgba(255,255,255,0.6) 40%, rgba(255,255,255,0) 70%);
            border-radius: 50%; opacity: 0;
            animation: flashSparkle 2.0s ease-in-out forwards;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.9));
        }
        .sparkle-cross::after, .sparkle-cross::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            background: rgba(255, 255, 255, 0.9); border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
        }
        .sparkle-cross::after { width: 4px; height: 100%; } 
        .sparkle-cross::before { width: 100%; height: 4px; } 

        @keyframes flashSparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(45deg); opacity: 0.9; }
            100% { transform: scale(0) rotate(90deg); opacity: 0; }
        }

        /* éš ã‚ŒãƒŸãƒƒã‚­ãƒ¼ */
        .hidden-mickey {
            position: absolute; width: 180px; height: 180px;
            transition: transform 3s ease-in-out; opacity: 0.8;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.2));
        }
        .mickey-left { left: -200px; top: 50%; }
        .mickey-left.show { transform: translateX(250px) rotate(15deg); }
        .mickey-right { right: -200px; top: 50%; }
        .mickey-right.show { transform: translateX(-250px) rotate(-15deg); }

        /* UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
        header {
            background: linear-gradient(135deg, var(--disney-blue), #0d1b38);
            color: white; padding: 10px 30px; border-bottom: 3px solid var(--disney-gold);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        
        /* ãƒ­ã‚´å‘¨ã‚Š */
        .logo-container {
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            text-decoration: none;
        }
        .logo-img { height: 45px; display: block; filter: brightness(0) invert(1); } /* ç™½ãåè»¢ */

        .search-container { position: relative; width: 300px; }
        .search-box { position: relative; display: flex; align-items: center; }
        .search-box i { position: absolute; left: 12px; color: var(--disney-blue); }
        .search-box input { width: 100%; padding: 8px 10px 8px 35px; border-radius: 20px; border: 1px solid var(--disney-gold); outline: none; }
        .search-results {
            position: absolute; top: 40px; left: 0; width: 100%; background: white;
            border: 1px solid var(--disney-gold); border-radius: 5px; z-index: 1001; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .search-item { padding: 10px; color: #333; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: #f0f0f0; }

        .wrapper { display: flex; max-width: 1400px; margin: 20px auto; background: white; min-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; z-index: 1; }
        .sidebar { width: 280px; padding: 20px; background: #fbfbfb; border-right: 1px solid #eee; }
        .main-content { flex: 1; padding: 40px; box-sizing: border-box; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¹ã‚¿ã‚¤ãƒ« */
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #aaa; margin-bottom: 20px; padding-bottom: 10px; }
        .intro-container { display: flex; gap: 30px; margin-bottom: 30px; align-items: flex-start; }
        .fixed-summary { flex: 1; font-size: 1.1em; line-height: 1.8; white-space: pre-wrap; word-break: break-all; }
        .infobox { width: 320px; border: 1px solid #aaa; background: #fff; padding: 5px; font-size: 90%; flex-shrink: 0; }
        .infobox-head { background: var(--disney-blue); color: white; text-align: center; padding: 10px; font-weight: bold; }
        .infobox img { width: 100%; border-bottom: 1px solid #eee; }
        .infobox table { width: 100%; border-collapse: collapse; }
        .infobox th { background: #f2f2f2; text-align: left; padding: 8px; width: 35%; border-bottom: 1px solid #eee; }
        .infobox td { padding: 8px; border-bottom: 1px solid #eee; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ */
        .content-block { margin-bottom: 30px; }
        h2 { border-bottom: 1px solid #aaa; color: var(--disney-blue); margin-top: 40px; padding-bottom: 5px; font-size: 1.8em; clear: both; }
        h3 { color: var(--disney-blue); margin-top: 25px; font-size: 1.4em; border-bottom: 1px dashed #ccc; }

        .media-box { 
            border: 1px solid #eee; background: #fafafa; padding: 10px; text-align: center; 
            cursor: pointer; transition: 0.2s; max-width: 100%; 
        }
        .media-box:hover { box-shadow: 0 0 10px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .media-preview-img { max-width: 100%; max-height: 300px; object-fit: contain; }
        .media-title { font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: var(--disney-blue); }
        
        .timeline-box { border: 1px solid #ccc; padding: 10px; background: white; cursor: default; }
        .timeline-row { display: flex; border-bottom: 1px dashed #eee; padding: 8px 0; }
        .tl-year { width: 80px; font-weight: bold; color: var(--disney-blue); flex-shrink: 0; text-align: right; padding-right: 15px; border-right: 2px solid var(--disney-gold); }
        .tl-event { padding-left: 15px; flex: 1; text-align: left; font-size: 0.95em; }

        .wiki-table { width: 100%; border-collapse: collapse; font-size: 14px; background: white; cursor: default; }
        .wiki-table th, .wiki-table td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        .wiki-table th { background: #f0f0f0; font-weight: bold; text-align: center; }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼‰é«˜æ©Ÿèƒ½ç‰ˆ --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 99999; display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        .modal-container {
            width: 100%; height: 100%; position: relative; overflow: hidden; /* ã‚³ãƒ³ãƒ†ãƒŠå¤–ã¸ã®ã¯ã¿å‡ºã—ã‚’éš ã™ */
            display: flex; justify-content: center; align-items: center;
        }

        .modal-content-wrapper {
            position: relative;
            transform-origin: center center;
            transition: transform 0.05s ease-out; /* ã‚ºãƒ¼ãƒ æ™‚ã®åå¿œé€Ÿåº¦ */
            user-select: none;
        }
        
        .modal-close { 
            position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; 
            cursor: pointer; z-index: 10010; text-shadow: 0 0 5px black; 
        }

        /* ç”»åƒãƒ»PDFãƒ»å‹•ç”»ã®è¡¨ç¤ºç”¨ */
        .view-media { display: block; max-width: 90vw; max-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        /* PDFç”¨ã¯å°‘ã—å¤§ãã‚ã« */
        .pdf-frame { width: 800px; height: 1100px; background: white; border: none; }
        
        /* ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ (ãƒ¡ãƒ‡ã‚£ã‚¢ã®ä¸Šã«é‡ã­ã‚‹) */
        .marker-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; cursor: crosshair;
        }

        .img-marker {
            position: absolute; width: 20px; height: 20px; 
            border-radius: 50%; cursor: pointer; z-index: 101;
            box-shadow: 0 0 4px rgba(0,0,0,0.8);
            border: 2px solid white;
            transform: translate(-50%, -50%); /* ä¸­å¿ƒã‚’åº§æ¨™ã«åˆã‚ã›ã‚‹ */
        }
        /* ãƒãƒ¼ã‚«ãƒ¼ãƒ›ãƒãƒ¼æ™‚ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .img-marker .tooltip {
            visibility: hidden; position: absolute; bottom: 130%; left: 50%; 
            transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; 
            padding: 5px 10px; border-radius: 4px; font-size: 12px; white-space: nowrap; 
            z-index: 102; opacity: 0; transition: 0.2s; pointer-events: none;
        }
        .img-marker:hover .tooltip { visibility: visible; opacity: 1; }

        .m-red { background: #ff3b30; }
        .m-blue { background: #007aff; }
        .m-green { background: #34c759; }
        .m-yellow { background: #ffcc00; }
        .m-black { background: #000000; }

        /* ãƒªãƒ³ã‚¯ã‚¹ã‚¿ã‚¤ãƒ« */
        a.wiki-link { color: #0645ad; font-weight: bold; text-decoration: none; cursor: pointer; }
        a.wiki-link.new { color: #ba0000; } /* æœªä½œæˆãƒšãƒ¼ã‚¸ */
        a.wiki-link:hover { text-decoration: underline; }
        a.ext-link { color: #3366bb; text-decoration: none; }
        a.ext-link:hover { text-decoration: underline; }
        a.ext-link::after { content: ' \f35d'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.7em; margin-left: 3px; }

        /* ç›®æ¬¡ */
        .toc-list { list-style: none; padding: 0; font-size: 14px; }
        .toc-link { color: #0645ad; text-decoration: none; cursor: pointer; display: block; padding: 5px 0; border-bottom: 1px solid #eee; }
        .toc-link:hover { background: #eee; }

        /* ã‚¨ãƒ‡ã‚£ã‚¿ */
        .editor-toolbar {
            background: #f8f9fa; border: 1px solid #ccc; padding: 8px;
            display: flex; gap: 5px; position: sticky; top: 60px; z-index: 900; margin-bottom: 20px;
            flex-wrap: nowrap; align-items: center; overflow-x: auto; white-space: nowrap;
        }
        .t-btn { background: white; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-family: sans-serif; white-space: nowrap; }
        .t-btn:hover { background: #eee; }
        
        .edit-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fffdf5; border-radius: 8px; position: relative; }
        .edit-area { width: 100%; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; font-family: inherit; font-size: 16px; }
        .edit-card-handle { cursor: grab; color: #ccc; margin-right: 10px; font-size: 20px; float: right; }

        /* Home Grid */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; cursor: pointer; transition: transform 0.2s; position: relative; }
        .page-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; text-align: center; font-family: 'Cinzel', serif; font-weight: bold; color: var(--disney-blue); overflow: hidden; text-overflow: ellipsis; }

        .btn-royal { background: var(--disney-blue); color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        .btn-danger { background: #d9534f; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-left: 10px; }

        .btn-magic-save {
            background-color: #c5a059; color: white; border: none; padding: 8px 18px; border-radius: 6px;
            font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: inline-flex; align-items: center; gap: 5px; white-space: nowrap;
        }
        .btn-magic-back {
            background-color: #ccc; color: white; border: none; padding: 8px 18px; border-radius: 6px;
            font-size: 14px; font-weight: bold; cursor: pointer; white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="effects-canvas"></div>
    <canvas id="fireworks-canvas"></canvas>

    <div id="media-modal" class="modal">
        <div class="modal-close" onclick="app.closeModal()">Ã—</div>
        <div class="modal-container" id="modal-container">
            <div id="modal-content-wrapper" class="modal-content-wrapper">
                <div id="media-inner" style="position: relative; display: inline-block;"></div>
            </div>
        </div>
    </div>

    <header>
        <div class="logo-container" onclick="app.goHome()">
            <a href="javascript:void(0)">
                <img src="https://fontmeme.com/permalink/260204/eabb3794.png" alt="DISNEY WIKI" border="0" class="logo-img">
            </a>
        </div>
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Wikiå†…ã‚’æ¤œç´¢..." oninput="app.searchLive(this.value)">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        <button id="auth-btn" class="btn-royal" style="background: var(--disney-gold); color: #000;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </header>

    <div class="wrapper">
        <aside class="sidebar" id="sidebar">
            <div style="font-weight:bold; border-bottom:1px solid var(--disney-gold); margin-bottom:10px;">å†…å®¹ / ç›®æ¬¡</div>
            <ul class="toc-list" id="toc-list"></ul>
            <button onclick="app.createNewPage()" style="margin-top:30px; cursor:pointer; border:1px dashed var(--disney-gold); padding:10px; background:none; width:100%; color: var(--disney-blue);">+ æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆ</button>
        </aside>

        <main class="main-content">
            <div id="view-mode">
                <div class="page-header" id="page-header-area">
                    <h1 id="display-title" style="font-family:'Cinzel',serif; font-size:2.5em; margin:0;"></h1>
                    <button class="btn-royal" onclick="app.toggleEdit()" style="background:none; border:1px solid #ccc; color:#666;">ã“ã®ãƒšãƒ¼ã‚¸ã‚’ç·¨é›† âœ</button>
                </div>
                
                <div id="home-view" class="hidden">
                    <p style="text-align:center; color:#666;">Wikiå†…ã®å…¨ãƒšãƒ¼ã‚¸ (ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆå¯èƒ½)</p>
                    <div id="home-grid" class="home-grid"></div>
                </div>

                <div id="page-content"></div>
            </div>

            <div id="edit-mode" class="hidden">
                <div class="editor-toolbar">
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('**','**')"><b>B</b></button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.applyLink('internal')"><i class="fas fa-link"></i> Wikiãƒªãƒ³ã‚¯</button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.applyLink('external')"><i class="fas fa-external-link-alt"></i> å¤–éƒ¨ãƒªãƒ³ã‚¯</button>
                    <div style="width:1px; background:#ccc; height:20px; margin:0 5px;"></div>
                    <button class="t-btn" onclick="editor.addBlock('image')"><i class="fas fa-image"></i> ç”»åƒ</button>
                    <button class="t-btn" onclick="editor.addBlock('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                    <button class="t-btn" onclick="editor.addBlock('video')"><i class="fas fa-video"></i> å‹•ç”»</button>
                    <button class="t-btn" onclick="editor.addBlock('table')"><i class="fas fa-table"></i> è¡¨</button>
                    <button class="t-btn" onclick="editor.addBlock('timeline')"><i class="fas fa-history"></i> æ™‚ç³»åˆ—</button>
                    <div style="flex-grow:1;"></div> 
                    <button class="btn-magic-save" onclick="app.savePage()">âœ¨ ä¿å­˜</button>
                    <button class="btn-magic-back" onclick="app.toggleEdit()">æˆ»ã‚‹</button>
                </div>

                <div class="edit-card" style="border: 2px solid var(--disney-blue);">
                    <h4 style="margin:0 0 10px 0; color:var(--disney-blue);">âœ¨ åŸºæœ¬è¨­å®š</h4>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-weight:bold; font-size:1.2em;" id="edit-title-display"></span>
                        <button class="btn-danger" onclick="app.deletePage()">ğŸ—‘ï¸ ã“ã®Wikiã‚’å‰Šé™¤</button>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="font-weight:bold;">ã‚µãƒ–é¡Œå (æ¤œç´¢ãƒ»ãƒªãƒ³ã‚¯ç”¨):</label>
                        <input type="text" id="edit-subtitles" class="edit-area" placeholder="ä¾‹: TDL, æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)" style="height:35px;">
                        <small style="color:#d9534f; display:none;" id="subtitle-error-msg">â€»æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹åå‰ã¯ä½¿ãˆã¾ã›ã‚“</small>
                    </div>
                    
                    <h4 style="margin:10px 0 5px 0; color:var(--disney-blue);">ã‚¤ãƒ³ãƒ•ã‚©ãƒœãƒƒã‚¯ã‚¹ (å³å´ã®æƒ…å ±æ )</h4>
                    <div style="display:flex; gap:15px; flex-wrap: wrap;">
                        <div style="flex:1;">
                            <label>æ¦‚è¦:</label>
                            <textarea id="edit-summary" class="edit-area" style="height:100px;"></textarea>
                        </div>
                        <div style="width:300px;">
                            <label>ç”»åƒURL:</label>
                            <input type="text" id="edit-ib-img" class="edit-area">
                            <label style="margin-top:5px; display:block;">ãƒ‡ãƒ¼ã‚¿é …ç›®:</label>
                            <div id="ib-rows-container"></div>
                            <button class="t-btn" onclick="editor.addIbRow()" style="width:100%; margin-top:5px;">+ è¿½åŠ </button>
                        </div>
                    </div>
                </div>

                <div id="editor-blocks-list"></div>
                <button onclick="editor.addBlock('section')" class="btn-royal" style="width:100%; margin-top:20px; background:#666;">+ è¦‹å‡ºã—ãƒ»æ–‡ç« ãƒ–ãƒ­ãƒƒã‚¯ã‚’è¿½åŠ </button>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXGAvYQnGZGIALlfsE93C4vBMR41Lp6QA",
            authDomain: "disney-wiki-b76e8.firebaseapp.com",
            projectId: "disney-wiki-b76e8",
            storageBucket: "disney-wiki-b76e8.firebasestorage.app",
            messagingSenderId: "929516211078",
            appId: "1:929516211078:web:a9c5b3a32a9a9c089e3a07"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const provider = new GoogleAuthProvider();

        // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ ---
        window.app = {
            currentPageId: 'home',
            currentUser: null,
            data: {}, // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿
            allPageCache: [], // å…¨ãƒšãƒ¼ã‚¸ã®IDã¨Subtitlesã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
            mediaState: { scale: 1, isDragging: false, startX: 0, startY: 0, translateX: 0, translateY: 0 }
        };

        // --- èµ·å‹•å‡¦ç† ---
        async function init() {
            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–‹å§‹
            initEffects();
            
            // ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦–
            onAuthStateChanged(auth, (user) => {
                window.app.currentUser = user;
                document.getElementById('auth-btn').textContent = user ? 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ' : 'ãƒ­ã‚°ã‚¤ãƒ³';
            });
            document.getElementById('auth-btn').onclick = () => {
                if(app.currentUser) signOut(auth);
                else signInWithPopup(auth, provider);
            };

            // å…¨ãƒšãƒ¼ã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆï¼ˆãƒªãƒ³ã‚¯é‡è¤‡ãƒã‚§ãƒƒã‚¯ & Homeè¡¨ç¤ºç”¨ï¼‰
            await refreshPageCache();

            // åˆæœŸãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰
            app.loadPage('home');
        }

        async function refreshPageCache() {
            const snap = await getDocs(collection(db, "pages"));
            app.allPageCache = [];
            snap.forEach(d => {
                const data = d.data();
                app.allPageCache.push({
                    id: d.id,
                    subtitles: data.subtitles || [],
                    img: data.infobox ? data.infobox.image : '',
                    order: data.homeOrder || 9999 // ä¸¦ã³é †
                });
            });
        }

        // --- ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ãƒ»è¡¨ç¤º ---
        window.app.loadPage = async function(pageId) {
            app.currentPageId = pageId;
            document.getElementById('view-mode').classList.remove('hidden');
            document.getElementById('edit-mode').classList.add('hidden');
            window.scrollTo(0,0);

            // Homeã®å ´åˆ
            if(pageId === 'home') {
                document.getElementById('display-title').style.display = 'none'; // ãƒ­ã‚´ãŒã‚¿ã‚¤ãƒˆãƒ«ä»£ã‚ã‚Š
                document.getElementById('page-content').innerHTML = '';
                document.getElementById('home-view').classList.remove('hidden');
                document.querySelector('.page-header button').classList.add('hidden'); // Homeã¯ç·¨é›†ä¸å¯
                renderHomeGrid();
                updateToc(null);
                return;
            }

            // é€šå¸¸ãƒšãƒ¼ã‚¸
            document.getElementById('display-title').style.display = 'block';
            document.getElementById('home-view').classList.add('hidden');
            document.querySelector('.page-header button').classList.remove('hidden');

            const docRef = doc(db, "pages", pageId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                app.data = docSnap.data();
                document.getElementById('display-title').innerText = pageId;
                renderPageContent(app.data);
                updateToc(app.data.blocks);
            } else {
                app.data = { blocks: [], infobox: {} }; // æ–°è¦æ‰±ã„ã ãŒã€ãƒ‡ãƒ¼ã‚¿ãªã—
                document.getElementById('display-title').innerText = pageId + " (æœªä½œæˆ)";
                document.getElementById('page-content').innerHTML = '<p>ã“ã®ãƒšãƒ¼ã‚¸ã¯ã¾ã é­”æ³•ãŒã‹ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
            }
        };

        function renderHomeGrid() {
            const grid = document.getElementById('home-grid');
            grid.innerHTML = '';
            
            // ä¸¦ã³é †ã§ã‚½ãƒ¼ãƒˆ
            let pages = [...app.allPageCache].sort((a,b) => (a.order || 0) - (b.order || 0));

            pages.forEach(p => {
                if(p.id === 'home' || p.id === 'config') return;
                const div = document.createElement('div');
                div.className = 'page-card';
                div.setAttribute('data-id', p.id);
                div.onclick = () => app.loadPage(p.id);
                
                const imgUrl = p.img || 'https://via.placeholder.com/300x150?text=No+Image';
                div.innerHTML = `
                    <img src="${imgUrl}" class="card-img">
                    <div class="card-body">${p.id}</div>
                `;
                grid.appendChild(div);
            });

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æœ‰åŠ¹åŒ–
            new Sortable(grid, {
                animation: 150,
                onEnd: async function () {
                    const newOrderIds = Array.from(grid.children).map(c => c.getAttribute('data-id'));
                    // é †ç•ªã‚’ä¿å­˜
                    for(let i=0; i<newOrderIds.length; i++) {
                        const pid = newOrderIds[i];
                        const ref = doc(db, "pages", pid);
                        // éƒ¨åˆ†æ›´æ–°ï¼ˆmergeï¼‰ã§orderã ã‘æ›¸ãæ›ãˆã‚‹
                        setDoc(ref, { homeOrder: i }, { merge: true });
                    }
                    await refreshPageCache(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
                }
            });
        }

        // --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (é‡è¦ä¿®æ­£: ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾å¿œ) ---
        function renderPageContent(data) {
            const container = document.getElementById('page-content');
            container.innerHTML = '';

            // 1. ã‚¤ãƒ³ãƒˆãƒ­ã‚¨ãƒªã‚¢ (æ¦‚è¦ + InfoBox)
            const introDiv = document.createElement('div');
            introDiv.className = 'intro-container';
            
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'fixed-summary';
            summaryDiv.innerHTML = processText(data.summary || '');
            
            const ibDiv = document.createElement('div');
            ibDiv.className = 'infobox';
            if(data.infobox) {
                let ibHtml = `<div class="infobox-head">${app.currentPageId}</div>`;
                if(data.infobox.image) ibHtml += `<img src="${data.infobox.image}">`;
                ibHtml += '<table>';
                if(data.infobox.rows) {
                    data.infobox.rows.forEach(r => {
                        ibHtml += `<tr><th>${r.key}</th><td>${processLink(r.val)}</td></tr>`;
                    });
                }
                ibHtml += '</table>';
                ibDiv.innerHTML = ibHtml;
            }

            introDiv.appendChild(summaryDiv);
            introDiv.appendChild(ibDiv);
            container.appendChild(introDiv);

            // 2. ãƒ–ãƒ­ãƒƒã‚¯ (ç”»åƒã€å‹•ç”»ã€PDFã€è¡¨ãªã©)
            if(data.blocks) {
                data.blocks.forEach((block, index) => {
                    const section = document.createElement('div');
                    section.className = 'content-block';
                    section.id = 'block-' + index;

                    if(block.type === 'section') {
                        section.innerHTML = `<h2>${block.title}</h2><div class="section-text">${processText(block.text)}</div>`;
                    } 
                    else if(block.type === 'image') {
                        section.innerHTML = `
                            <h3>${block.title || 'ç”»åƒ'}</h3>
                            <div class="media-box" onclick='app.openMedia("image", "${block.url}", ${JSON.stringify(block.markers || [])}, ${index})'>
                                <img src="${block.url}" class="media-preview-img">
                                <div class="media-title">ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ‹¡å¤§ / ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º</div>
                            </div>
                        `;
                    }
                    else if(block.type === 'video') {
                        section.innerHTML = `
                            <h3>${block.title || 'å‹•ç”»'}</h3>
                            <div class="media-box" onclick='app.openMedia("video", "${block.url}", [], ${index})'>
                                <i class="fas fa-play-circle" style="font-size:40px; color:var(--disney-blue);"></i>
                                <div class="media-title">ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ç”»ã‚’å†ç”Ÿ</div>
                            </div>
                        `;
                    }
                    else if(block.type === 'pdf') {
                        section.innerHTML = `
                            <h3>${block.title || 'PDFè³‡æ–™'}</h3>
                            <div class="media-box" onclick='app.openMedia("pdf", "${block.url}", ${JSON.stringify(block.markers || [])}, ${index})'>
                                <i class="fas fa-file-pdf" style="font-size:40px; color:#d9534f;"></i>
                                <div class="media-title">PDFã‚’é–‹ã (ãƒãƒ¼ã‚«ãƒ¼å¯¾å¿œ)</div>
                            </div>
                        `;
                    }
                    else if(block.type === 'table') {
                        section.innerHTML = `<h3>${block.title || 'è¡¨'}</h3>`;
                        const tbl = document.createElement('table');
                        tbl.className = 'wiki-table';
                        const rows = block.data || [];
                        rows.forEach((r, i) => {
                            const tr = document.createElement('tr');
                            r.forEach(c => {
                                const cell = document.createElement(i===0 ? 'th' : 'td');
                                cell.innerHTML = processLink(c);
                                tr.appendChild(cell);
                            });
                            tbl.appendChild(tr);
                        });
                        section.appendChild(tbl);
                    }
                    else if(block.type === 'timeline') {
                        section.innerHTML = `<h3>${block.title || 'å¹´è¡¨'}</h3>`;
                        const tlDiv = document.createElement('div');
                        tlDiv.className = 'timeline-box';
                        (block.data || []).forEach(item => {
                            tlDiv.innerHTML += `
                                <div class="timeline-row">
                                    <div class="tl-year">${item.year}</div>
                                    <div class="tl-event">${processLink(item.event)}</div>
                                </div>`;
                        });
                        section.appendChild(tlDiv);
                    }

                    container.appendChild(section);
                });
            }
        }

        // --- ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ»ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ (å®Œå…¨æ”¹ä¿®) ---
        let currentMediaBlockIndex = -1;
        let currentMarkers = [];
        let isMarkerMode = false;

        window.app.openMedia = function(type, url, markers, blockIndex) {
            const modal = document.getElementById('media-modal');
            const container = document.getElementById('modal-content-wrapper');
            const inner = document.getElementById('media-inner');
            
            currentMediaBlockIndex = blockIndex;
            currentMarkers = markers || [];
            
            // ãƒªã‚»ãƒƒãƒˆ
            container.style.transform = 'translate(0px, 0px) scale(1)';
            app.mediaState = { scale: 1, translateX: 0, translateY: 0 };
            inner.innerHTML = '';

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ
            if (type === 'image') {
                const img = document.createElement('img');
                img.src = url;
                img.className = 'view-media';
                img.onload = () => renderMarkers(inner); // ç”»åƒãƒ­ãƒ¼ãƒ‰å¾Œã«ãƒãƒ¼ã‚«ãƒ¼æç”»
                inner.appendChild(img);
                setupZoomPan(container);
            } 
            else if (type === 'pdf') {
                // PDFã¯iframeã§è¡¨ç¤ºã—ã€ãã®ä¸Šã«ãƒãƒ¼ã‚«ãƒ¼ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¢«ã›ã‚‹
                const frame = document.createElement('iframe');
                frame.src = url;
                frame.className = 'view-media pdf-frame';
                inner.appendChild(frame);
                // PDFã®ä¸Šã«é€æ˜ãªdivã‚’ç½®ã„ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¾ã†ï¼†ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
                const overlay = document.createElement('div');
                overlay.className = 'marker-layer';
                // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ã‚¤ãƒ™ãƒ³ãƒˆ
                overlay.onclick = (e) => handleMarkerPlace(e, overlay);
                inner.appendChild(overlay);
                
                renderMarkers(overlay); // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ä¸Šã«æç”»
                setupZoomPan(container);
            }
            else if (type === 'video') {
                // å‹•ç”»ã¯ã‚ºãƒ¼ãƒ ä¸è¦ã€å˜ç´”è¡¨ç¤º
                if (url.includes('youtube.com') || url.includes('youtu.be')) {
                    // YouTubeç°¡æ˜“å¯¾å¿œ
                    let vId = url.split('v=')[1];
                    if(!vId) vId = url.split('/').pop();
                    const amp = vId.indexOf('&');
                    if(amp != -1) vId = vId.substring(0, amp);
                    
                    inner.innerHTML = `<iframe width="800" height="450" src="https://www.youtube.com/embed/${vId}" frameborder="0" allowfullscreen class="view-media"></iframe>`;
                } else {
                    const vid = document.createElement('video');
                    vid.src = url;
                    vid.controls = true;
                    vid.className = 'view-media';
                    vid.style.maxHeight = '80vh';
                    inner.appendChild(vid);
                }
                // å‹•ç”»ã®å ´åˆã¯ã‚ºãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä»˜ã‘ãªã„
            }

            modal.classList.add('active');
            document.body.classList.add('noscroll');
        };

        window.app.closeModal = function() {
            document.getElementById('media-modal').classList.remove('active');
            document.getElementById('media-inner').innerHTML = ''; // å‹•ç”»åœæ­¢ãªã©
            document.body.classList.remove('noscroll');
        };

        // ãƒãƒ¼ã‚«ãƒ¼æç”»
        function renderMarkers(targetContainer) {
            // æ—¢å­˜ãƒãƒ¼ã‚«ãƒ¼å‰Šé™¤ï¼ˆå†æç”»ç”¨ï¼‰
            const existing = targetContainer.querySelectorAll('.img-marker');
            existing.forEach(e => e.remove());

            currentMarkers.forEach(m => {
                const mk = document.createElement('div');
                mk.className = `img-marker m-${m.color || 'red'}`;
                mk.style.left = m.x + '%';
                mk.style.top = m.y + '%';
                mk.innerHTML = `<div class="tooltip">${m.text || ''} ${m.link ? 'ğŸ”—' : ''}</div>`;
                if(m.link) {
                    mk.onclick = (e) => {
                        e.stopPropagation(); // è¨­ç½®ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«é˜²æ­¢
                        if(m.linkType === 'wiki') app.loadPage(m.link);
                        else window.open(m.link, '_blank');
                        app.closeModal();
                    };
                }
                targetContainer.appendChild(mk);
            });
        }

        // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ãƒ­ã‚¸ãƒƒã‚¯
        function handleMarkerPlace(e, container) {
            // æ—¢ã«ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚‹å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯ãã¡ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒå„ªå…ˆã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã¯æ–°è¦è¨­ç½®
            if (!app.currentUser) return; // ç·¨é›†æ¨©é™ãªã‘ã‚Œã°ç„¡è¦–ï¼ˆç°¡æ˜“ï¼‰
            // rectå–å¾—ï¼ˆã‚ºãƒ¼ãƒ ã•ã‚Œã¦ã„ã¦ã‚‚ã€ã‚¯ãƒªãƒƒã‚¯åº§æ¨™ã¯è¦ç´ ç›¸å¯¾ã§è¨ˆç®—ã™ã‚‹å¿…è¦ã‚ã‚Šï¼‰
            const rect = container.getBoundingClientRect();
            // ã‚ºãƒ¼ãƒ ã®å½±éŸ¿ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ï¼…ã‚’è¨ˆç®—ã™ã‚‹ã®ã¯è¤‡é›‘ã ãŒã€
            // containerè‡ªä½“ãŒscaleã•ã‚Œã¦ã„ã‚‹å ´åˆã€offsetX/Yã¯å…ƒã®ã‚µã‚¤ã‚ºåŸºæº–ã§å–ã‚Œã‚‹ã“ã¨ãŒå¤šã„
            
            // e.offsetX / e.offsetY ã‚’ä½¿ã†ã®ãŒä¸€ç•ªç´ ç›´ (targetãŒcontainerã®å ´åˆ)
            const xPct = (e.offsetX / container.offsetWidth) * 100;
            const yPct = (e.offsetY / container.offsetHeight) * 100;

            const name = prompt("ãƒãƒ¼ã‚«ãƒ¼ã®åå‰:");
            if(!name) return;
            const color = prompt("è‰² (red, blue, green, yellow, black):", "red");
            const link = prompt("ãƒªãƒ³ã‚¯å…ˆ (Wikiãƒšãƒ¼ã‚¸å ã¾ãŸã¯ URL)ã€‚ç©ºæ¬„ãªã‚‰ãªã—:");
            const linkType = (link && link.startsWith('http')) ? 'external' : 'wiki';

            const newMarker = { x: xPct, y: yPct, text: name, color: color, link: link, linkType: linkType };
            currentMarkers.push(newMarker);
            
            renderMarkers(container);

            // ãƒ‡ãƒ¼ã‚¿ã‚’å³æ™‚ä¿å­˜ï¼ˆã¾ãŸã¯ç·¨é›†ä¸­ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ï¼‰
            // ä»Šå›ã®è¦ä»¶ã§ã¯ã€Œç·¨é›†ç”»é¢ã€ã§ã¯ãªã„å ´æ‰€ï¼ˆViewerï¼‰ã§ã®æ“ä½œã ãŒã€
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“çš„ã«ã¯ã€Œè¦‹ã¦ã‚‹æ™‚ã«è¶³ã—ãŸã„ã€ã€‚
            // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã€app.dataå†…ã®è©²å½“ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ›´æ–°ã—ã€Firestoreã«ä¿å­˜ã™ã‚‹ã€‚
            if(app.data && app.data.blocks && currentMediaBlockIndex >= 0) {
                app.data.blocks[currentMediaBlockIndex].markers = currentMarkers;
                // ä¿å­˜
                const ref = doc(db, "pages", app.currentPageId);
                setDoc(ref, { blocks: app.data.blocks }, { merge: true });
                alert("ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            }
        }

        // ã‚ºãƒ¼ãƒ ï¼†ãƒ‘ãƒ³æ©Ÿèƒ½
        function setupZoomPan(wrapper) {
            const container = document.getElementById('modal-container');
            
            // ãƒ›ã‚¤ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ ï¼‰
            container.onwheel = (e) => {
                if(e.ctrlKey) {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    app.mediaState.scale *= delta;
                    // æœ€å°ãƒ»æœ€å¤§åˆ¶é™
                    if(app.mediaState.scale < 0.5) app.mediaState.scale = 0.5;
                    if(app.mediaState.scale > 5.0) app.mediaState.scale = 5.0;
                    applyTransform(wrapper);
                }
            };

            // ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆç§»å‹•ï¼‰
            let isDown = false;
            let startX, startY;

            wrapper.onmousedown = (e) => {
                // ãƒãƒ¼ã‚«ãƒ¼è¨­ç½®ã¨ç«¶åˆã—ãªã„ã‚ˆã†ã€Ctrlã‚­ãƒ¼ãªã—ã®ãƒ‰ãƒ©ãƒƒã‚°ã®ã¿ç§»å‹•ã¨ã™ã‚‹ã€ã‚ã‚‹ã„ã¯ç”»åƒãã®ã‚‚ã®ã®ãƒ‰ãƒ©ãƒƒã‚°
                // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã€Œç”»åƒä¸Šã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã¯ç§»å‹•ã€ã¨ã™ã‚‹
                isDown = true;
                startX = e.clientX - app.mediaState.translateX;
                startY = e.clientY - app.mediaState.translateY;
                wrapper.style.cursor = 'grabbing';
            };

            window.onmouseup = () => { isDown = false; wrapper.style.cursor = 'default'; };

            window.onmousemove = (e) => {
                if(!isDown) return;
                e.preventDefault();
                app.mediaState.translateX = e.clientX - startX;
                app.mediaState.translateY = e.clientY - startY;
                applyTransform(wrapper);
            };
        }

        function applyTransform(el) {
            el.style.transform = `translate(${app.mediaState.translateX}px, ${app.mediaState.translateY}px) scale(${app.mediaState.scale})`;
        }


        // --- ã‚¨ãƒ‡ã‚£ã‚¿é–¢é€£ ---
        window.app.toggleEdit = function() {
            const view = document.getElementById('view-mode');
            const edit = document.getElementById('edit-mode');
            
            if(view.classList.contains('hidden')) {
                // ç·¨é›† -> é–²è¦§ (ã‚­ãƒ£ãƒ³ã‚»ãƒ«)
                app.loadPage(app.currentPageId);
            } else {
                // é–²è¦§ -> ç·¨é›†
                view.classList.add('hidden');
                edit.classList.remove('hidden');
                
                // ã‚¨ãƒ‡ã‚£ã‚¿ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('edit-title-display').textContent = app.currentPageId;
                document.getElementById('edit-summary').value = app.data.summary || '';
                document.getElementById('edit-subtitles').value = (app.data.subtitles || []).join(', ');
                document.getElementById('edit-ib-img').value = (app.data.infobox && app.data.infobox.image) || '';
                
                const ibContainer = document.getElementById('ib-rows-container');
                ibContainer.innerHTML = '';
                if(app.data.infobox && app.data.infobox.rows) {
                    app.data.infobox.rows.forEach(r => editor.addIbRow(r.key, r.val));
                }

                const blocksList = document.getElementById('editor-blocks-list');
                blocksList.innerHTML = '';
                if(app.data.blocks) {
                    app.data.blocks.forEach(b => editor.renderBlockEditor(b));
                }
            }
        };

        window.editor = {
            blocksData: [], // ç·¨é›†ä¸­ã®ä¸€æ™‚ä¿å­˜
            
            addIbRow: (k='', v='') => {
                const div = document.createElement('div');
                div.style.display = 'flex'; div.style.marginBottom = '5px';
                div.innerHTML = `
                    <input type="text" class="edit-area" value="${k}" placeholder="é …ç›®å" style="width:40%; margin-right:5px;">
                    <input type="text" class="edit-area" value="${v}" placeholder="å†…å®¹">
                    <button onclick="this.parentElement.remove()" style="margin-left:5px;">Ã—</button>
                `;
                document.getElementById('ib-rows-container').appendChild(div);
            },

            addBlock: (type) => {
                const block = { type: type };
                if(type === 'section') { block.title = ''; block.text = ''; }
                else if(type === 'image' || type === 'video' || type === 'pdf') { block.title = ''; block.url = ''; block.markers = []; }
                else if(type === 'table') { block.title = ''; block.data = [['é …ç›®1','é …ç›®2'],['å†…å®¹1','å†…å®¹2']]; }
                else if(type === 'timeline') { block.title = ''; block.data = [{year:'2000', event:'å‡ºæ¥äº‹'}]; }
                
                editor.renderBlockEditor(block);
            },

            renderBlockEditor: (block) => {
                const container = document.getElementById('editor-blocks-list');
                const div = document.createElement('div');
                div.className = 'edit-card';
                
                // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã¨å‰Šé™¤ãƒœã‚¿ãƒ³
                let html = `
                    <div style="margin-bottom:10px; overflow:hidden;">
                        <span class="edit-card-handle">â˜°</span>
                        <strong style="color:var(--disney-blue); text-transform:uppercase;">${block.type}</strong>
                        <button onclick="this.closest('.edit-card').remove()" style="float:right; color:red;">å‰Šé™¤</button>
                    </div>
                    <label>è¦‹å‡ºã— (ä»»æ„):</label>
                    <input type="text" class="b-title edit-area" value="${block.title || ''}" style="margin-bottom:10px;">
                    <input type="hidden" class="b-type" value="${block.type}">
                `;

                if(block.type === 'section') {
                    html += `<label>æœ¬æ–‡:</label><textarea class="b-text edit-area" style="height:150px;">${block.text || ''}</textarea>`;
                } else if(['image','video','pdf'].includes(block.type)) {
                    html += `<label>URL:</label><input type="text" class="b-url edit-area" value="${block.url || ''}">`;
                    if(block.markers) {
                        html += `<input type="hidden" class="b-markers" value='${JSON.stringify(block.markers)}'>`;
                        html += `<small>â€»ãƒãƒ¼ã‚«ãƒ¼ã¯ä¿å­˜å¾Œã«é–²è¦§ç”»é¢ã§ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¿½åŠ ã§ãã¾ã™ã€‚</small>`;
                    }
                } else if(block.type === 'table') {
                    const json = JSON.stringify(block.data);
                    html += `<label>CSVå½¢å¼ã§ç·¨é›† (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š):</label><textarea class="b-table-raw edit-area" style="height:100px;">${block.data.map(r=>r.join(',')).join('\n')}</textarea>`;
                } else if(block.type === 'timeline') {
                     const json = JSON.stringify(block.data);
                     html += `<label>å¹´,å‡ºæ¥äº‹ (æ”¹è¡ŒåŒºåˆ‡ã‚Š):</label><textarea class="b-timeline-raw edit-area" style="height:100px;">${block.data.map(r=> r.year+','+r.event).join('\n')}</textarea>`;
                }

                div.innerHTML = html;
                container.appendChild(div);
                
                // Sortableæœ‰åŠ¹åŒ– (ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦1å›ã‚„ã‚Œã°ã„ã„ãŒã€ç°¡æ˜“çš„ã«ã“ã“ã§)
                new Sortable(container, { handle: '.edit-card-handle', animation: 150 });
            },

            // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½
            apply: (tagS, tagE) => {
                const activeEl = document.activeElement;
                if(!activeEl || activeEl.tagName !== 'TEXTAREA') return;
                const start = activeEl.selectionStart;
                const end = activeEl.selectionEnd;
                const text = activeEl.value;
                activeEl.value = text.substring(0, start) + tagS + text.substring(start, end) + tagE + text.substring(end);
            },
            
            applyLink: (type) => {
                const activeEl = document.activeElement;
                if(!activeEl || activeEl.tagName !== 'TEXTAREA') return;
                
                const text = activeEl.value.substring(activeEl.selectionStart, activeEl.selectionEnd);
                if(type === 'internal') {
                    // å†…éƒ¨ãƒªãƒ³ã‚¯ä½œæˆæ™‚ã€æ—¢å­˜ãƒšãƒ¼ã‚¸ã‹ãƒã‚§ãƒƒã‚¯
                    const pageName = prompt("ãƒªãƒ³ã‚¯å…ˆã®Wikiãƒšãƒ¼ã‚¸å:", text);
                    if(pageName) {
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ã§ä½œæˆã¯è¨±å¯ã™ã‚‹ãŒã€èµ¤å­—ã«ã™ã‚‹ã‹ã©ã†ã‹ã¯renderæ™‚ï¼‰
                        const exists = checkPageExists(pageName);
                        if(!exists) alert("æ³¨æ„: ãã®ãƒšãƒ¼ã‚¸ã¯ã¾ã å­˜åœ¨ã—ã¾ã›ã‚“ï¼ˆèµ¤ãƒªãƒ³ã‚¯ã«ãªã‚Šã¾ã™ï¼‰");
                        editor.apply('[[' + pageName + ']]', ''); 
                    }
                } else {
                    const url = prompt("URL:", "https://");
                    if(url) editor.apply('[' + (text||'ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ') + '](' + url + ')', '');
                }
            }
        };

        // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ ---
        window.app.savePage = async function() {
            const pageId = app.currentPageId;
            const subsInput = document.getElementById('edit-subtitles').value;
            const subtitles = subsInput.split(',').map(s => s.trim()).filter(s => s);
            
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯ (è‡ªåˆ†è‡ªèº«ã‚’é™¤ã)
            for(const s of subtitles) {
                if(checkDuplicate(s, pageId)) {
                    alert(`ã‚¨ãƒ©ãƒ¼: ã‚µãƒ–é¡Œåã€Œ${s}ã€ã¯æ—¢ã«ä»–ã®ãƒšãƒ¼ã‚¸ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                    return;
                }
            }

            const summary = document.getElementById('edit-summary').value;
            const ibImg = document.getElementById('edit-ib-img').value;
            
            const ibRows = [];
            document.querySelectorAll('#ib-rows-container > div').forEach(div => {
                const inputs = div.querySelectorAll('input');
                if(inputs[0].value) ibRows.push({ key: inputs[0].value, val: inputs[1].value });
            });

            const blocks = [];
            document.querySelectorAll('#editor-blocks-list .edit-card').forEach(card => {
                const type = card.querySelector('.b-type').value;
                const title = card.querySelector('.b-title').value;
                let block = { type, title };

                if(type === 'section') {
                    block.text = card.querySelector('.b-text').value;
                } else if(['image','video','pdf'].includes(type)) {
                    block.url = card.querySelector('.b-url').value;
                    const mVal = card.querySelector('.b-markers');
                    if(mVal) block.markers = JSON.parse(mVal.value);
                } else if(type === 'table') {
                    const raw = card.querySelector('.b-table-raw').value;
                    block.data = raw.split('\n').map(line => line.split(','));
                } else if(type === 'timeline') {
                    const raw = card.querySelector('.b-timeline-raw').value;
                    block.data = raw.split('\n').map(line => {
                        const idx = line.indexOf(',');
                        return { year: line.substring(0, idx), event: line.substring(idx+1) };
                    });
                }
                blocks.push(block);
            });

            const dataToSave = {
                subtitles,
                summary,
                infobox: { image: ibImg, rows: ibRows },
                blocks,
                // homeOrderãªã©ã¯ç¶­æŒã™ã‚‹ãŸã‚ã« merge:true ã‚’ä½¿ã†ãŒã€
                // ä¸Šè¨˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä¸Šæ›¸ãã•ã‚Œã‚‹
            };

            await setDoc(doc(db, "pages", pageId), dataToSave, { merge: true });
            
            await refreshPageCache(); // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
            alert("é­”æ³•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼âœ¨");
            app.loadPage(pageId);
        };

        // --- æ–°è¦ãƒšãƒ¼ã‚¸ä½œæˆ ---
        window.app.createNewPage = async function() {
            const title = prompt("æ–°ã—ã„ãƒšãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
            if(!title) return;

            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            if(checkDuplicate(title, null)) {
                alert("ãã®åå‰ï¼ˆã¾ãŸã¯ã‚µãƒ–é¡Œåï¼‰ã®ãƒšãƒ¼ã‚¸ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
                return;
            }

            app.loadPage(title);
            // è‡ªå‹•ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã¸
            setTimeout(() => app.toggleEdit(), 500);
        };

        // --- ãƒšãƒ¼ã‚¸å‰Šé™¤ ---
        window.app.deletePage = async function() {
            if(!confirm("æœ¬å½“ã«ã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) return;
            
            await deleteDoc(doc(db, "pages", app.currentPageId));
            await refreshPageCache();
            alert("ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
            app.goHome();
        };

        // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
        
        // ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ (Wikiãƒªãƒ³ã‚¯ãªã©)
        function processText(text) {
            if(!text) return '';
            let t = text.replace(/\n/g, '<br>');
            // [[Link]]
            t = t.replace(/\[\[(.*?)\]\]/g, (match, p1) => {
                const exists = checkPageExists(p1);
                const cls = exists ? 'wiki-link' : 'wiki-link new';
                return `<a class="${cls}" onclick="app.loadPage('${p1}')">${p1}</a>`;
            });
            // **Bold**
            t = t.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            return t;
        }

        function processLink(text) {
            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„InfoBoxå†…ã®ç°¡æ˜“ãƒªãƒ³ã‚¯å‡¦ç†
            return processText(text);
        }

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯: nameãŒIDã¾ãŸã¯subtitlesã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹
        function checkDuplicate(name, excludeId) {
            return app.allPageCache.some(p => {
                if(p.id === excludeId) return false; // è‡ªåˆ†è‡ªèº«ã¯é™¤å¤–
                if(p.id === name) return true;
                if(p.subtitles && p.subtitles.includes(name)) return true;
                return false;
            });
        }

        function checkPageExists(name) {
            return app.allPageCache.some(p => p.id === name || (p.subtitles && p.subtitles.includes(name)));
        }

        // ç›®æ¬¡æ›´æ–°
        function updateToc(blocks) {
            const list = document.getElementById('toc-list');
            list.innerHTML = '';
            
            // Homeã¸ã®ãƒªãƒ³ã‚¯
            const homeLi = document.createElement('li');
            homeLi.innerHTML = `<a class="toc-link" onclick="app.goHome()">ğŸ  Home</a>`;
            list.appendChild(homeLi);

            if(!blocks) return;

            blocks.forEach((b, i) => {
                if(b.title) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a class="toc-link" onclick="document.getElementById('block-${i}').scrollIntoView({behavior:'smooth'})">${b.title}</a>`;
                    list.appendChild(li);
                }
            });
        }

        // æ¤œç´¢æ©Ÿèƒ½
        window.app.searchLive = function(query) {
            const resDiv = document.getElementById('search-results');
            if(!query) { resDiv.style.display = 'none'; return; }
            
            resDiv.innerHTML = '';
            resDiv.style.display = 'block';
            
            const hits = app.allPageCache.filter(p => {
                return p.id.toLowerCase().includes(query.toLowerCase()) || 
                       p.subtitles.some(s => s.toLowerCase().includes(query.toLowerCase()));
            });

            hits.forEach(p => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerText = p.id;
                div.onclick = () => {
                    app.loadPage(p.id);
                    document.getElementById('search-input').value = '';
                    resDiv.style.display = 'none';
                };
                resDiv.appendChild(div);
            });
            
            if(hits.length === 0) {
                resDiv.innerHTML = '<div style="padding:10px;">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            }
        };

        window.app.goHome = () => app.loadPage('home');

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆå‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰
        function initEffects() {
            // ã‚­ãƒ©ã‚­ãƒ©
            const container = document.getElementById('effects-canvas');
            setInterval(() => {
                if(document.hidden) return; 
                const star = document.createElement('div');
                star.className = 'sparkle-cross';
                const isLeft = Math.random() > 0.5;
                const leftPos = isLeft ? Math.random() * 10 : 90 + Math.random() * 10;
                star.style.left = leftPos + '%'; star.style.top = (Math.random() * 100) + '%';
                container.appendChild(star);
                setTimeout(() => star.remove(), 2500);
            }, 500);

            // éš ã‚ŒãƒŸãƒƒã‚­ãƒ¼
            const spawnMickey = () => {
                const colors = ['#000000', '#FF0000', '#0000FF'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                const div = document.createElement('div');
                div.className = 'hidden-mickey ' + (Math.random()>0.5 ? 'mickey-left':'mickey-right');
                div.innerHTML = `<svg viewBox="0 0 100 100" style="width:100%; height:100%;"><circle cx="20" cy="20" r="20" fill="${color}" /><circle cx="80" cy="20" r="20" fill="${color}" /><circle cx="50" cy="55" r="28" fill="${color}" /></svg>`;
                div.style.top = (20 + Math.random() * 60) + '%';
                container.appendChild(div);
                setTimeout(() => div.classList.add('show'), 100);
                setTimeout(() => div.remove(), 15000); 
            };
            setInterval(() => { if(Math.random() > 0.7) spawnMickey(); }, 10000);
            
            // èŠ±ç« (Canvas)
            const canvas = document.getElementById('fireworks-canvas');
            const ctx = canvas.getContext('2d');
            const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
            window.addEventListener('resize', resize); resize();
            
            let particles = [];
            const animate = () => {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fillRect(0,0,canvas.width, canvas.height);
                ctx.globalCompositeOperation = 'lighter';
                
                particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= 0.01;
                    ctx.fillStyle = `hsla(${p.hue}, 100%, 50%, ${p.alpha})`;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
                    if(p.alpha <= 0) particles.splice(i, 1);
                });
                requestAnimationFrame(animate);
            };
            animate();
            
            // èŠ±ç«æ‰“ã¡ä¸Šã’ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰
            setInterval(() => {
                if(document.hidden) return;
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height * 0.5;
                const hue = Math.random() * 360;
                for(let i=0; i<30; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const v = Math.random() * 3 + 1;
                    particles.push({ x:x, y:y, vx:Math.cos(angle)*v, vy:Math.sin(angle)*v, alpha:1, hue:hue });
                }
            }, 4000);
        }

        // èµ·å‹•
        init();

    </script>
</body>
</html>
