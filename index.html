<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Wiki - Pro Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --wiki-blue: #3366cc;
            --wiki-bg: #f6f6f6;
            --border-color: #a2a9b1;
            --header-bg: #ffffff;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            margin: 0; padding: 0; background-color: var(--wiki-bg); color: #202122;
        }

        /* --- ヘッダー & 検索 --- */
        header {
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            padding: 5px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000; height: 50px;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { font-family: 'serif'; font-size: 24px; cursor: pointer; font-weight: bold; color: #000; text-decoration: none; }
        
        .search-container { position: relative; width: 300px; }
        .search-input { 
            width: 100%; padding: 8px 35px 8px 10px; border: 1px solid var(--border-color); border-radius: 2px;
        }
        .search-icon { position: absolute; right: 10px; top: 10px; color: #777; }

        /* --- レイアウト --- */
        .wrapper { display: flex; max-width: 100%; margin: 0 auto; min-height: calc(100vh - 60px); }
        
        /* サイドバー (目次) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--wiki-bg);
            padding: 20px;
            border-right: 1px solid #eaecf0;
            overflow-y: auto;
        }
        .toc-item { margin-bottom: 5px; list-style: none; padding-left: 15px; position: relative; }
        .toc-toggle { 
            position: absolute; left: -5px; cursor: pointer; font-size: 10px; transition: 0.2s;
        }
        .toc-link { text-decoration: none; color: var(--wiki-blue); font-size: 14px; }
        .toc-link:hover { text-decoration: underline; }
        .collapsed .toc-sub { display: none; }
        .collapsed .toc-toggle { transform: rotate(-90deg); }

        /* メインコンテンツ */
        .content-area { flex: 1; background: white; padding: 40px; border-left: 1px solid #eaecf0; }

        /* --- 編集用ツールバー (Wikipedia風) --- */
        .editor-toolbar {
            background: #f8f9fa; border: 1px solid var(--border-color);
            padding: 5px; display: flex; gap: 5px; flex-wrap: wrap;
            position: sticky; top: 50px; z-index: 999;
        }
        .toolbar-btn {
            background: white; border: 1px solid #c8ccd1; padding: 5px 10px;
            cursor: pointer; font-size: 13px; border-radius: 2px;
        }
        .toolbar-btn:hover { background: #eee; }
        .toolbar-sep { width: 1px; background: #c8ccd1; margin: 0 5px; }

        /* --- 記事スタイル --- */
        .page-title { font-family: 'Noto Serif JP', serif; font-size: 2.5em; border-bottom: 1px solid var(--border-color); margin-bottom: 0.25em; }
        h2 { border-bottom: 1px solid var(--border-color); margin-top: 1.5em; }
        h3 { border-bottom: none; margin-top: 1.2em; }
        
        .infobox {
            float: right; width: 300px; border: 1px solid var(--border-color);
            background: #f8f9fa; margin: 0 0 1em 1em; padding: 5px; font-size: 88%;
        }
        .infobox th { background: #cedff2; text-align: left; padding: 5px; width: 40%; }
        .infobox td { padding: 5px; }

        /* --- トップページ特別スタイル --- */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #fff; cursor: pointer; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card-img { width: 100%; height: 150px; object-fit: cover; background: #eee; }
        .card-body { padding: 15px; }
        .card-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; }

        /* --- 編集画面の入力 --- */
        .edit-container { display: none; }
        .editing .edit-container { display: block; }
        .editing .view-container { display: none; }

        .section-editor { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; background: #fdfdfd; }
        textarea.content-input { width: 100%; min-height: 150px; font-family: monospace; }
        
        /* ユーティリティ */
        .hidden { display: none; }
        .btn-primary { background: #36c; color: white; border: none; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="logo" onclick="app.router('home')"><i class="fas fa-magic"></i> Disney Wiki</div>
            <div class="search-container">
                <input type="text" id="search-input" class="search-input" placeholder="Wiki内を検索..." onkeypress="if(event.key==='Enter') app.search()">
                <i class="fas fa-search search-icon"></i>
            </div>
        </div>
        <div class="auth-panel">
            <button id="auth-btn" class="toolbar-btn">ログイン</button>
        </div>
    </header>

    <div class="wrapper">
        <aside class="sidebar" id="sidebar">
            <div id="toc-area">
                <h4 style="border-bottom: 1px solid #ccc;">目次</h4>
                <ul id="toc-list" style="padding:0; margin:0;"></ul>
            </div>
        </aside>

        <main class="content-area">
            <div id="view-mode" class="view-container">
                <div id="page-content">
                    </div>
                <div style="margin-top:40px;">
                    <button class="toolbar-btn" id="edit-start-btn" onclick="app.toggleEdit()">編集</button>
                </div>
            </div>

            <div id="edit-mode" class="edit-container">
                <div class="editor-toolbar" id="toolbar">
                    <button class="toolbar-btn" onclick="editor.insert('**','**')"><b>B</b></button>
                    <button class="toolbar-btn" onclick="editor.insert('*','*')"><i>I</i></button>
                    <button class="toolbar-btn" onclick="editor.insert('<u>','</u>')"><u>U</u></button>
                    <button class="toolbar-btn" onclick="editor.insert('~~','~~')"><s>S</s></button>
                    <div class="toolbar-sep"></div>
                    <button class="toolbar-btn" onclick="editor.insert('[[',']]')"><i class="fas fa-link"></i> Wiki内リンク</button>
                    <button class="toolbar-btn" onclick="editor.insert('https://en.wiktionary.org/wiki/%E5%90%8D%E5%89%8D')"><i class="fas fa-external-link-alt"></i> 外部リンク</button>
                    <div class="toolbar-sep"></div>
                    <button class="toolbar-btn" onclick="editor.insert('[[Image:',']]')"><i class="fas fa-image"></i> 画像</button>
                    <button class="toolbar-btn" onclick="editor.insert('[[Video:',']]')"><i class="fas fa-video"></i> 動画</button>
                    <button class="toolbar-btn" onclick="editor.insertTable()"><i class="fas fa-table"></i> 表挿入</button>
                    <div class="toolbar-sep"></div>
                    <button class="toolbar-btn" onclick="app.savePage()" style="background:#36c; color:white;">変更を公開</button>
                    <button class="toolbar-btn" onclick="app.toggleEdit()">キャンセル</button>
                </div>

                <h1 id="edit-title-display"></h1>
                <div id="section-editors-list"></div>
                <button class="toolbar-btn" onclick="editor.addSection()" style="width:100%; margin-top:10px;">+ 新しい見出しを追加</button>
                
                <div id="home-editor-extra" class="hidden">
                    <h3>トップページに表示するページID (カンマ区切り)</h3>
                    <input type="text" id="home-featured-pages" style="width:100%; padding:10px;">
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXGAvYQnGZGIALlfsE93C4vBMR41Lp6QA",
            authDomain: "disney-wiki-b76e8.firebaseapp.com",
            projectId: "disney-wiki-b76e8",
            storageBucket: "disney-wiki-b76e8.firebasestorage.app",
            messagingSenderId: "929516211078",
            appId: "1:929516211078:web:a9c5b3a32a9a9c089e3a07"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const provider = new GoogleAuthProvider();

        window.app = {
            currentPageId: 'home',
            currentUser: null,
            data: {},

            init: async function() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    document.getElementById('auth-btn').textContent = user ? 'ログアウト' : 'ログイン';
                    document.getElementById('auth-btn').onclick = () => user ? signOut(auth) : signInWithPopup(auth, provider);
                });
                window.addEventListener('hashchange', () => this.router());
                this.router();
            },

            router: function() {
                const id = decodeURIComponent(window.location.hash.replace('#', '')) || 'home';
                this.currentPageId = id;
                this.loadPage(id);
            },

            loadPage: async function(id) {
                const docRef = doc(db, "pages", id);
                const snap = await getDoc(docRef);
                
                if (snap.exists()) {
                    this.data = snap.data();
                } else {
                    this.data = { title: id, sections: [], infobox: { image: '', rows: [] }, featured: [] };
                }
                this.render();
            },

            render: function() {
                const isHome = this.currentPageId === 'home';
                document.getElementById('sidebar').style.display = isHome ? 'none' : 'block';
                
                const container = document.getElementById('page-content');
                container.innerHTML = `<h1 class="page-title">${this.data.title || this.currentPageId}</h1>`;

                if (isHome) {
                    this.renderHome(container);
                } else {
                    this.renderWikiPage(container);
                    this.renderTOC();
                }
            },

            renderWikiPage: function(container) {
                // Infobox
                if(this.data.infobox?.image || this.data.infobox?.rows?.length) {
                    let ib = `<table class="infobox"><tr><th colspan="2" style="text-align:center; background:#ccf;">${this.data.title}</th></tr>`;
                    if(this.data.infobox.image) ib += `<tr><td colspan="2"><img src="${this.data.infobox.image}" style="width:100%"></td></tr>`;
                    this.data.infobox.rows.forEach(r => ib += `<tr><th>${r.key}</th><td>${r.value}</td></tr>`);
                    ib += `</table>`;
                    container.innerHTML += ib;
                }

                // Sections
                this.data.sections?.forEach((sec, i) => {
                    const tag = sec.level === 3 ? 'h3' : 'h2';
                    container.innerHTML += `<${tag} id="s-${i}">${sec.heading}</${tag}>`;
                    container.innerHTML += `<div>${this.parseWikiText(sec.content)}</div>`;
                });
            },

            renderHome: async function(container) {
                container.innerHTML += `<p>ようこそ Disney Wiki へ！知りたい項目を検索するか、以下の特集記事をご覧ください。</p>`;
                const grid = document.createElement('div');
                grid.className = 'home-grid';
                
                const pages = this.data.featured || [];
                for (const id of pages) {
                    const snap = await getDoc(doc(db, "pages", id.trim()));
                    if(snap.exists()){
                        const d = snap.data();
                        grid.innerHTML += `
                            <div class="card" onclick="location.hash='${id.trim()}'">
                                <img src="${d.infobox?.image || ''}" class="card-img">
                                <div class="card-body">
                                    <div class="card-title">${d.title}</div>
                                </div>
                            </div>`;
                    }
                }
                container.appendChild(grid);
            },

            renderTOC: function() {
                const list = document.getElementById('toc-list');
                list.innerHTML = '';
                this.data.sections?.forEach((sec, i) => {
                    if (sec.level === 3) return; // 子要素は親の中で処理
                    
                    const li = document.createElement('li');
                    li.className = 'toc-item';
                    li.innerHTML = `<a href="#s-${i}" class="toc-link">${i+1}. ${sec.heading}</a>`;
                    
                    // 次の要素がレベル3なら子リストとして追加
                    const subList = document.createElement('ul');
                    subList.className = 'toc-sub';
                    let hasSub = false;
                    
                    for(let j = i + 1; j < this.data.sections.length; j++) {
                        if(this.data.sections[j].level === 3) {
                            hasSub = true;
                            subList.innerHTML += `<li class="toc-item"><a href="#s-${j}" class="toc-link">${this.data.sections[j].heading}</a></li>`;
                        } else break;
                    }
                    
                    if(hasSub) {
                        const toggle = document.createElement('span');
                        toggle.className = 'toc-toggle';
                        toggle.innerHTML = '<i class="fas fa-chevron-down"></i>';
                        toggle.onclick = () => li.classList.toggle('collapsed');
                        li.prepend(toggle);
                        li.appendChild(subList);
                    }
                    list.appendChild(li);
                });
            },

            parseWikiText: function(txt) {
                if(!txt) return '';
                return txt
                    .replace(/\*\* (.*?) \*\*/g, '<b>$1</b>')
                    .replace(/\* (.*?) \*/g, '<i>$1</i>')
                    .replace(/\[\[(.*?)\]\]/g, '<a href="#$1" style="color:#36c">$1</a>')
                    .replace(/\[(https?:\/\/\S+)\s(.*?)\]/g, '<a href="$1" target="_blank">$2 <i class="fas fa-external-link-alt" style="font-size:10px;"></i></a>')
                    .replace(/\[\[Image:(.*?)\]\]/g, '<img src="$1" style="max-width:100%; margin:10px 0;">')
                    .replace(/\[\[Video:(.*?)\]\]/g, '<video src="$1" controls style="max-width:100%;"></video>')
                    .replace(/\n/g, '<br>');
            },

            toggleEdit: function() {
                if(!this.currentUser) return alert('ログインが必要です');
                document.body.classList.toggle('editing');
                if(document.body.classList.contains('editing')) editor.init();
            },

            savePage: async function() {
                const updated = editor.getOutput();
                await setDoc(doc(db, "pages", this.currentPageId), updated);
                location.reload();
            },

            search: async function() {
                const val = document.getElementById('search-input').value;
                if(val) window.location.hash = val;
            }
        };

        window.editor = {
            init: function() {
                document.getElementById('edit-title-display').textContent = app.data.title;
                const list = document.getElementById('section-editors-list');
                list.innerHTML = '';
                
                // Infobox Editor
                let ibHtml = `<div class="section-editor"><h4>Infobox設定</h4>
                    画像URL: <input type="text" id="edit-ib-img" value="${app.data.infobox?.image || ''}" style="width:80%"><br>
                    項目(キー:値, カンマ区切り): <textarea id="edit-ib-rows" style="width:100%">${app.data.infobox?.rows?.map(r=>`${r.key}:${r.value}`).join(',') || ''}</textarea>
                </div>`;
                list.innerHTML = ibHtml;

                app.data.sections?.forEach((sec, i) => this.addSection(sec));
                
                if(app.currentPageId === 'home') {
                    document.getElementById('home-editor-extra').classList.remove('hidden');
                    document.getElementById('home-featured-pages').value = app.data.featured?.join(',') || '';
                }
            },

            addSection: function(data = {heading:'', content:'', level:2}) {
                const div = document.createElement('div');
                div.className = 'section-editor';
                div.innerHTML = `
                    レベル: <select class="sec-level"><option value="2" ${data.level==2?'selected':''}>見出し(H2)</option><option value="3" ${data.level==3?'selected':''}>小見出し(H3)</option></select>
                    見出し名: <input type="text" class="sec-head" value="${data.heading}" style="width:70%">
                    <button onclick="this.parentElement.remove()">削除</button>
                    <textarea class="content-input">${data.content}</textarea>
                `;
                document.getElementById('section-editors-list').appendChild(div);
            },

            insert: function(before, after) {
                const active = document.activeElement;
                if(active.tagName === 'TEXTAREA') {
                    const start = active.selectionStart;
                    const end = active.selectionEnd;
                    const val = active.value;
                    active.value = val.substring(0, start) + before + val.substring(start, end) + after + val.substring(end);
                }
            },

            insertTable: function() {
                const rows = prompt("行数は？", "3");
                const cols = prompt("列数は？", "3");
                let table = "\n{| class=\"wiki-table\"\n";
                for(let i=0; i<rows; i++) {
                    table += "|-\n";
                    for(let j=0; j<cols; j++) table += "| セル \n";
                }
                table += "|}\n";
                this.insert(table, "");
            },

            getOutput: function() {
                const sections = [];
                document.querySelectorAll('.section-editor').forEach(el => {
                    const h = el.querySelector('.sec-head')?.value;
                    if(h !== undefined) {
                        sections.push({
                            heading: h,
                            level: parseInt(el.querySelector('.sec-level').value),
                            content: el.querySelector('.content-input').value
                        });
                    }
                });

                const ibRowsRaw = document.getElementById('edit-ib-rows').value;
                const infobox = {
                    image: document.getElementById('edit-ib-img').value,
                    rows: ibRowsRaw.split(',').filter(r=>r.includes(':')).map(r => {
                        const [k, v] = r.split(':');
                        return {key: k.trim(), value: v.trim()};
                    })
                };

                return {
                    title: app.data.title,
                    sections: sections,
                    infobox: infobox,
                    featured: document.getElementById('home-featured-pages')?.value.split(',') || []
                };
            }
        };

        app.init();
    </script>
</body>
</html>
