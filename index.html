<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disney Wiki - Royal Editor</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --disney-blue: #1e366e;
            --disney-gold: #c5a059;
            --bg-color: #f4f5f7;
            --wiki-border: #a2a9b1;
        }

        body { font-family: 'Noto Serif JP', serif; background-color: var(--bg-color); margin: 0; color: #202122; }

        /* „Éò„ÉÉ„ÉÄ„Éº„ÉªÊ§úÁ¥¢ */
        header {
            background: linear-gradient(135deg, var(--disney-blue), #0d1b38);
            color: white; padding: 10px 30px; border-bottom: 3px solid var(--disney-gold);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-family: 'Cinzel', serif; font-size: 26px; font-weight: bold; color: var(--disney-gold); cursor: pointer; }
        
        .search-container { position: relative; width: 300px; }
        .search-box { position: relative; display: flex; align-items: center; }
        .search-box i { position: absolute; left: 12px; color: var(--disney-blue); }
        .search-box input { width: 100%; padding: 8px 10px 8px 35px; border-radius: 20px; border: 1px solid var(--disney-gold); outline: none; }
        
        .search-results {
            position: absolute; top: 40px; left: 0; width: 100%; background: white;
            border: 1px solid var(--disney-gold); border-radius: 5px; z-index: 1001; display: none;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .search-item { padding: 10px; color: #333; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-item:hover { background: #f0f0f0; }

        /* „É¨„Ç§„Ç¢„Ç¶„Éà */
        .wrapper { display: flex; max-width: 1400px; margin: 20px auto; background: white; min-height: 90vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .sidebar { width: 280px; padding: 20px; background: #fbfbfb; border-right: 1px solid #eee; }
        .main-content { flex: 1; padding: 40px; box-sizing: border-box; }

        /* ÁõÆÊ¨° */
        .toc-title { font-weight: bold; border-bottom: 1px solid var(--disney-gold); margin-bottom: 10px; padding-bottom: 5px; }
        .toc-list { list-style: none; padding: 0; font-size: 14px; }
        .toc-item { margin: 5px 0; position: relative; padding-left: 20px; }
        .toc-link { color: #0645ad; text-decoration: none; cursor: pointer; }
        .toc-link:hover { text-decoration: underline; }

        /* Ë®ò‰∫ãË°®Á§∫Ôºö„Çª„ÇØ„Ç∑„Éß„É≥„Å®„É°„Éá„Ç£„Ç¢„ÅÆ‰∏¶„Å≥ */
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 1px solid #aaa; margin-bottom: 20px; padding-bottom: 10px; }
        .section-wrapper { display: flex; gap: 30px; margin-bottom: 30px; }
        .section-text { flex: 1; min-width: 0; }
        .section-media { width: 320px; flex-shrink: 0; }

        /* „Ç§„É≥„Éï„Ç©„Éú„ÉÉ„ÇØ„Çπ */
        .infobox { width: 320px; border: 1px solid #aaa; background: #fff; padding: 5px; font-size: 90%; float: right; margin-left: 20px; }
        .infobox-head { background: var(--disney-blue); color: white; text-align: center; padding: 10px; font-weight: bold; }
        .infobox table { width: 100%; border-collapse: collapse; }
        .infobox th { background: #f2f2f2; text-align: left; padding: 8px; width: 35%; border-bottom: 1px solid #eee; }
        .infobox td { padding: 8px; border-bottom: 1px solid #eee; }

        /* Á∑®ÈõÜ„É¢„Éº„ÉâÂÖ±ÈÄö */
        .editor-toolbar {
            background: #f8f9fa; border: 1px solid var(--wiki-border); padding: 8px;
            display: flex; gap: 5px; position: sticky; top: 60px; z-index: 1000; margin-bottom: 20px;
        }
        .t-btn { background: white; border: 1px solid #ccc; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-size: 13px; }
        .t-btn:hover { background: #e0e0e0; }

        /* Á∑®ÈõÜ„Ç´„Éº„Éâ */
        .edit-card { 
            border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; background: #fffdf5; 
            border-radius: 8px; position: relative; cursor: grab;
        }
        .edit-card:active { cursor: grabbing; }
        .edit-card-handle { position: absolute; left: -10px; top: 50%; transform: translateY(-50%); color: #ccc; cursor: grab; }
        
        .edit-area { width: 100%; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; font-family: serif; }
        .editable-table-wrap { overflow-x: auto; margin-top: 10px; }
        .editable-table { width: 100%; border-collapse: collapse; background: white; }
        .editable-table td { border: 1px solid #ccc; padding: 0; }
        .editable-table input, .editable-table textarea { width: 100%; border: none; padding: 8px; box-sizing: border-box; outline: none; }

        /* TOP„Éö„Éº„Ç∏Áî®„Ç∞„É™„ÉÉ„Éâ */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 30px; }
        .page-card { border: 1px solid #ddd; border-radius: 10px; overflow: hidden; transition: 0.3s; cursor: pointer; background: white; }
        .page-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
        .card-img { width: 100%; height: 180px; object-fit: cover; }
        .card-body { padding: 15px; text-align: center; font-family: 'Cinzel', serif; font-weight: bold; color: var(--disney-blue); }

        .btn-royal { background: var(--disney-blue); color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <header>
        <div class="logo" onclick="app.goHome()">‚ú® Disney Wiki</div>
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="WikiÂÜÖ„ÇíÊ§úÁ¥¢..." oninput="app.searchLive(this.value)">
            </div>
            <div id="search-results" class="search-results"></div>
        </div>
        <button id="auth-btn" class="btn-royal" style="background: var(--disney-gold); color: #000;">„É≠„Ç∞„Ç§„É≥</button>
    </header>

    <div class="wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="toc-title">ÂÜÖÂÆπ / ÁõÆÊ¨°</div>
            <ul class="toc-list" id="toc-list"></ul>
            <button onclick="app.createNewPage()" style="margin-top:30px; cursor:pointer; border:1px dashed var(--disney-gold); padding:10px; background:none; width:100%;">+ Êñ∞Ë¶è„Éö„Éº„Ç∏‰ΩúÊàê</button>
        </aside>

        <main class="main-content">
            <div id="view-mode">
                <div class="page-header">
                    <h1 class="page-title" id="display-title" style="font-family:'Cinzel',serif; font-size:2.5em; margin:0;"></h1>
                    <button class="btn-royal" onclick="app.toggleEdit()" style="background:none; border:1px solid #ccc; color:#666; font-size:14px;">„Åì„ÅÆ„Éö„Éº„Ç∏„ÇíÁ∑®ÈõÜ„Åô„Çã ‚úé</button>
                </div>
                <div id="page-content"></div>
            </div>

            <div id="edit-mode" class="hidden">
                <div id="editor-toolbar-box" class="editor-toolbar">
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('**','**')"><b>B</b></button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('*','*')"><i>I</i></button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('<u>','</u>')"><u>U</u></button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('~~','~~')"><s>S</s></button>
                    <div style="width:1px; background:#ccc; margin:0 5px;"></div>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('[[',']]')"><i class="fas fa-link"></i> WikiÂÜÖ</button>
                    <button class="t-btn" onmousedown="event.preventDefault(); editor.apply('https://en.wiktionary.org/wiki/%E5%90%8D%E5%89%8D')"><i class="fas fa-external-link-alt"></i> Â§ñÈÉ®</button>
                    <div style="width:1px; background:#ccc; margin:0 5px;"></div>
                    <button class="t-btn" onclick="editor.addBlock('image')"><i class="fas fa-image"></i> ÁîªÂÉè/GIF</button>
                    <button class="t-btn" onclick="editor.addBlock('video')"><i class="fas fa-video"></i> ÂãïÁîª</button>
                    <button class="t-btn" onclick="editor.addBlock('table')"><i class="fas fa-table"></i> Ë°®</button>
                    <div style="flex-grow:1"></div>
                    <button class="t-btn" onclick="app.savePage()" style="background:var(--disney-gold); font-weight:bold;">‚ú® È≠îÊ≥ï„Çí‰øùÂ≠ò</button>
                    <button class="t-btn" onclick="app.toggleEdit()">Êàª„Çã</button>
                </div>

                <div id="edit-fields-wiki">
                    <div class="edit-card" style="cursor:default">
                        <h4>„Ç§„É≥„Éï„Ç©„Éú„ÉÉ„ÇØ„ÇπË®≠ÂÆö</h4>
                        ÁîªÂÉèURL: <input type="text" id="edit-ib-img" class="edit-area" style="margin-bottom:10px;">
                        <div class="editable-table-wrap">
                            <table class="editable-table">
                                <tbody id="ib-rows-body"></tbody>
                            </table>
                        </div>
                        <button onclick="editor.addIbRow()" class="t-btn" style="margin-top:10px;">+ È†ÖÁõÆ„ÇíËøΩÂä†</button>
                    </div>

                    <div id="editor-blocks-list"></div>
                    
                    <button onclick="editor.addBlock('section')" class="btn-royal" style="width:100%; margin-top:20px; background:#666;">+ Êñ∞„Åó„ÅÑË¶ãÂá∫„Åó„ÉªÊñáÁ´†„ÇíËøΩÂä†</button>
                </div>

                <div id="edit-fields-home" class="hidden">
                    <div class="edit-card">
                        <h3>üè† „Éà„ÉÉ„Éó„Éö„Éº„Ç∏Ë®≠ÂÆö</h3>
                        <p>Ë°®Á§∫„Åó„Åü„ÅÑ„Éö„Éº„Ç∏ID„Çí„Ç´„É≥„ÉûÂå∫Âàá„Çä„ÅßÂÖ•ÂäõÔºö</p>
                        <input type="text" id="home-featured-input" class="edit-area" placeholder="Mickey, TDL, TDS">
                    </div>
                    <div style="margin-top:20px; text-align:center;">
                        <button class="btn-royal" onclick="app.savePage()" style="background:var(--disney-gold); font-weight:bold;">‚ú® È≠îÊ≥ï„Çí‰øùÂ≠ò</button>
                        <button class="btn-royal" onclick="app.toggleEdit()" style="background:#ccc;">Êàª„Çã</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXGAvYQnGZGIALlfsE93C4vBMR41Lp6QA",
            authDomain: "disney-wiki-b76e8.firebaseapp.com",
            projectId: "disney-wiki-b76e8",
            storageBucket: "disney-wiki-b76e8.firebasestorage.app",
            messagingSenderId: "929516211078",
            appId: "1:929516211078:web:a9c5b3a32a9a9c089e3a07"
        };

        const fApp = initializeApp(firebaseConfig);
        const auth = getAuth(fApp);
        const db = getFirestore(fApp);
        const provider = new GoogleAuthProvider();

        window.app = {
            currentPageId: 'home',
            currentUser: null,
            data: {},
            history: [],

            init: function() {
                onAuthStateChanged(auth, (user) => {
                    this.currentUser = user;
                    document.getElementById('auth-btn').textContent = user ? '„É≠„Ç∞„Ç¢„Ç¶„Éà' : '„É≠„Ç∞„Ç§„É≥';
                    document.getElementById('auth-btn').onclick = () => user ? signOut(auth) : signInWithPopup(auth, provider);
                });
                window.addEventListener('hashchange', () => this.router());
                window.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'z' && !document.getElementById('edit-mode').classList.contains('hidden')) {
                        editor.undo();
                    }
                });
                this.router();
            },

            router: function() {
                const h = decodeURIComponent(location.hash.replace('#', '')) || 'home';
                this.currentPageId = h;
                this.loadPage(h);
                window.scrollTo(0,0);
            },

            goHome: function() { location.hash = 'home'; },

            loadPage: async function(id) {
                const snap = await getDoc(doc(db, "pages", id));
                if (snap.exists()) {
                    this.data = snap.data();
                } else {
                    this.data = { title: id, blocks: [], infobox: { image:'', rows:[] }, featured: [] };
                }
                this.render();
            },

            render: function() {
                const isHome = this.currentPageId === 'home';
                document.getElementById('sidebar').classList.toggle('hidden', isHome);
                document.getElementById('display-title').textContent = this.data.title;
                const container = document.getElementById('page-content');
                container.innerHTML = '';

                if (isHome) {
                    this.renderHome(container);
                } else {
                    this.renderWiki(container);
                    this.renderTOC();
                }
            },

            renderWiki: function(container) {
                // Infobox
                const ib = this.data.infobox;
                if(ib && (ib.image || ib.rows?.length)) {
                    let html = `<div class="infobox"><div class="infobox-head">${this.data.title}</div>`;
                    if(ib.image) html += `<img src="${ib.image}" style="width:100%">`;
                    html += `<table>`;
                    ib.rows?.forEach(r => html += `<tr><th>${r.key}</th><td>${this.parse(r.value)}</td></tr>`);
                    html += `</table></div>`;
                    container.innerHTML += html;
                }

                // Blocks Rendering (Side-by-side logic)
                let currentWrapper = null;
                let currentMediaArea = null;

                this.data.blocks?.forEach((b, i) => {
                    if(b.type === 'section') {
                        currentWrapper = document.createElement('div');
                        currentWrapper.className = 'section-wrapper';
                        currentWrapper.id = `block-${i}`;
                        const textPart = document.createElement('div');
                        textPart.className = 'section-text';
                        textPart.innerHTML = `<h2 id="sec-${i}">${b.heading}</h2><div>${this.parse(b.content)}</div>`;
                        currentWrapper.appendChild(textPart);
                        
                        currentMediaArea = document.createElement('div');
                        currentMediaArea.className = 'section-media';
                        currentWrapper.appendChild(currentMediaArea);
                        container.appendChild(currentWrapper);
                    } else if (currentMediaArea) {
                        // Ê¨°„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅåÂá∫„Çã„Åæ„Åß„ÅÆ„É°„Éá„Ç£„Ç¢„ÇíÂè≥ÂÅ¥„Å´ÂÖ•„Çå„Çã
                        const m = document.createElement('div');
                        m.style.marginBottom = '15px';
                        if(b.type === 'image') m.innerHTML = `<img src="${b.url}" style="width:100%; border:1px solid #ccc;">`;
                        if(b.type === 'video') m.innerHTML = `<video src="${b.url}" controls style="width:100%"></video>`;
                        if(b.type === 'table') m.innerHTML = this.renderTable(b.data);
                        currentMediaArea.appendChild(m);
                    }
                });
            },

            renderTable: function(data) {
                let html = '<table border="1" style="width:100%; border-collapse:collapse; font-size:14px;">';
                data.forEach(row => {
                    html += '<tr>' + row.map(cell => `<td style="padding:5px;">${this.parse(cell)}</td>`).join('') + '</tr>';
                });
                return html + '</table>';
            },

            renderHome: async function(container) {
                const grid = document.createElement('div');
                grid.className = 'home-grid';
                for(const id of (this.data.featured || [])) {
                    const s = await getDoc(doc(db, "pages", id.trim()));
                    if(s.exists()){
                        const d = s.data();
                        grid.innerHTML += `
                            <div class="page-card" onclick="location.hash='${id.trim()}'">
                                <img src="${d.infobox.image}" class="card-img">
                                <div class="card-body">${d.title}</div>
                            </div>`;
                    }
                }
                container.appendChild(grid);
            },

            renderTOC: function() {
                const list = document.getElementById('toc-list');
                list.innerHTML = '';
                this.data.blocks?.forEach((b, i) => {
                    if(b.type === 'section') {
                        const li = document.createElement('li');
                        li.className = 'toc-item';
                        li.innerHTML = `<a class="toc-link" onclick="app.scrollToBlock(${i})">${b.heading}</a>`;
                        list.appendChild(li);
                    }
                });
            },

            scrollToBlock: function(index) {
                const isEdit = !document.getElementById('edit-mode').classList.contains('hidden');
                const id = isEdit ? `edit-card-${index}` : `sec-${index}`;
                const el = document.getElementById(id);
                if(el) window.scrollTo({ top: el.offsetTop - 80, behavior: 'smooth' });
            },

            parse: function(t) {
                if(!t) return '';
                return t
                    .replace(/\*\* (.*?) \*\*/g, '<b>$1</b>').replace(/\* (.*?) \*/g, '<i>$1</i>')
                    .replace(/\[\[(.*?)\]\]/g, '<a href="#$1" style="color:#0645ad">$1</a>')
                    .replace(/\[(https?:\/\/\S+)\s(.*?)\]/g, '<a href="$1" target="_blank" style="color:#36b">$2 <i class="fas fa-external-link-alt" style="font-size:10px"></i></a>')
                    .replace(/\n/g, '<br>');
            },

            searchLive: async function(val) {
                const resDiv = document.getElementById('search-results');
                if(!val) { resDiv.style.display = 'none'; return; }
                const q = query(collection(db, "pages"));
                const snap = await getDocs(q);
                resDiv.innerHTML = '';
                let count = 0;
                snap.forEach(doc => {
                    if(doc.id.toLowerCase().includes(val.toLowerCase()) && count < 8) {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.textContent = doc.id;
                        item.onclick = () => { location.hash = doc.id; resDiv.style.display = 'none'; };
                        resDiv.appendChild(item);
                        count++;
                    }
                });
                resDiv.style.display = count > 0 ? 'block' : 'none';
            },

            toggleEdit: function() {
                if(!this.currentUser) return alert('„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô');
                document.getElementById('view-mode').classList.toggle('hidden');
                document.getElementById('edit-mode').classList.toggle('hidden');
                if(!document.getElementById('edit-mode').classList.contains('hidden')) {
                    this.history = [JSON.stringify(this.data)];
                    editor.load();
                }
            },

            savePage: async function() {
                const updated = editor.collect();
                await setDoc(doc(db, "pages", this.currentPageId), updated);
                location.reload();
            },

            createNewPage: function() {
                const n = prompt("Êñ∞„Åó„ÅÑ„Éö„Éº„Ç∏Âêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                if(n) location.hash = n;
            }
        };

        window.editor = {
            activeInput: null,
            sortable: null,

            load: function() {
                const isHome = app.currentPageId === 'home';
                document.getElementById('edit-fields-wiki').classList.toggle('hidden', isHome);
                document.getElementById('edit-fields-home').classList.toggle('hidden', !isHome);
                document.getElementById('editor-toolbar-box').classList.toggle('hidden', isHome);

                if(!isHome) {
                    document.getElementById('edit-ib-img').value = app.data.infobox.image || '';
                    const ibBody = document.getElementById('ib-rows-body');
                    ibBody.innerHTML = '';
                    app.data.infobox.rows?.forEach(r => this.addIbRow(r));
                    
                    const blockList = document.getElementById('editor-blocks-list');
                    blockList.innerHTML = '';
                    app.data.blocks?.forEach((b, i) => this.addBlock(b.type, b, i));
                    this.initSortable();
                } else {
                    document.getElementById('home-featured-input').value = app.data.featured?.join(', ') || '';
                }
            },

            initSortable: function() {
                if(this.sortable) this.sortable.destroy();
                this.sortable = Sortable.create(document.getElementById('editor-blocks-list'), {
                    handle: '.edit-card-handle',
                    animation: 150,
                    onEnd: () => this.saveHistory()
                });
            },

            addIbRow: function(data = {key:'', value:''}) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="text" class="ib-key" value="${data.key}" placeholder="È†ÖÁõÆÂêç"></td>
                    <td><textarea class="ib-val" placeholder="ÂÜÖÂÆπ">${data.value}</textarea></td>
                    <td style="width:40px; text-align:center;"><button onclick="this.parentElement.parentElement.remove()">‚ùå</button></td>
                `;
                document.getElementById('ib-rows-body').appendChild(tr);
            },

            addBlock: function(type, data = null, index = null) {
                const list = document.getElementById('editor-blocks-list');
                const card = document.createElement('div');
                card.className = 'edit-card';
                card.dataset.type = type;
                if(index !== null) card.id = `edit-card-${index}`;

                let content = `<div class="edit-card-handle">‚†ø</div>`;
                if(type === 'section') {
                    content += `Ë¶ãÂá∫„Åó: <input type="text" class="b-head edit-area" value="${data?.heading || ''}" oninput="editor.liveTOC()">
                                ÊñáÁ´†: <textarea class="b-content edit-area" style="height:100px">${data?.content || ''}</textarea>`;
                } else if(type === 'image') {
                    content += `ÁîªÂÉè/GIF URL: <input type="text" class="b-url edit-area" value="${data?.url || ''}">`;
                } else if(type === 'video') {
                    content += `ÂãïÁîª URL: <input type="text" class="b-url edit-area" value="${data?.url || ''}">`;
                } else if(type === 'table') {
                    content += `<div class="editable-table-wrap"><table class="editable-table"><tbody>`;
                    const tableData = data?.data || [['',''],['','']];
                    tableData.forEach(row => {
                        content += `<tr>${row.map(c => `<td><textarea class="cell-val">${c}</textarea></td>`).join('')}<td><button onclick="this.parentElement.parentElement.remove()">„Éº</button></td></tr>`;
                    });
                    content += `</tbody></table></div><button onclick="editor.addTableRow(this)">+ Ë°åËøΩÂä†</button>`;
                }
                content += `<button onclick="this.parentElement.remove(); editor.liveTOC();" style="position:absolute; right:10px; top:10px;">ÂâäÈô§</button>`;
                
                card.innerHTML = content;
                list.appendChild(card);
                
                // ÂÖ•Âäõ„Éï„Ç©„Éº„Ç´„ÇπÊôÇ„Å´„ÉÑ„Éº„É´„Éê„Éº„Åå‰Ωø„Åà„Çã„Çà„ÅÜ„Å´„Åô„Çã
                card.querySelectorAll('textarea, input').forEach(el => {
                    el.onfocus = () => this.activeInput = el;
                });
                
                if(!data) { // Êñ∞Ë¶èËøΩÂä†ÊôÇ„ÅØ„Çπ„ÇØ„É≠„Éº„É´
                    card.scrollIntoView({behavior:'smooth'});
                    this.liveTOC();
                }
            },

            addTableRow: function(btn) {
                const tbody = btn.previousSibling.querySelector('tbody');
                const colCount = tbody.rows[0].cells.length - 1;
                const tr = document.createElement('tr');
                for(let i=0; i<colCount; i++) tr.innerHTML += `<td><textarea class="cell-val"></textarea></td>`;
                tr.innerHTML += `<td><button onclick="this.parentElement.parentElement.remove()">„Éº</button></td>`;
                tbody.appendChild(tr);
            },

            liveTOC: function() {
                const tempBlocks = [];
                document.querySelectorAll('#editor-blocks-list .edit-card').forEach((el, i) => {
                    if(el.dataset.type === 'section') {
                        tempBlocks.push({ type:'section', heading: el.querySelector('.b-head').value });
                    }
                });
                const list = document.getElementById('toc-list');
                list.innerHTML = '';
                tempBlocks.forEach((b, i) => {
                    const li = document.createElement('li');
                    li.className = 'toc-item';
                    li.innerHTML = `<a class="toc-link" onclick="app.scrollToBlock(${i})">${b.heading || '(ÁÑ°È°å)'}</a>`;
                    list.appendChild(li);
                });
            },

            apply: function(before, after) {
                const el = this.activeInput;
                if(!el) return;
                const s = el.selectionStart;
                const e = el.selectionEnd;
                const val = el.value;
                el.value = val.substring(0, s) + before + val.substring(s, e) + after + val.substring(e);
                el.focus();
                this.saveHistory();
            },

            saveHistory: function() {
                const state = JSON.stringify(this.collect());
                if(app.history[app.history.length-1] !== state) {
                    app.history.push(state);
                    if(app.history.length > 20) app.history.shift();
                }
            },

            undo: function() {
                if(app.history.length > 1) {
                    app.history.pop();
                    app.data = JSON.parse(app.history[app.history.length-1]);
                    this.load();
                }
            },

            collect: function() {
                const isHome = app.currentPageId === 'home';
                if(isHome) {
                    return {
                        title: 'home',
                        featured: document.getElementById('home-featured-input').value.split(',').map(s=>s.trim()).filter(s=>s)
                    };
                }
                const ibRows = [];
                document.querySelectorAll('#ib-rows-body tr').forEach(tr => {
                    ibRows.push({ key: tr.querySelector('.ib-key').value, value: tr.querySelector('.ib-val').value });
                });
                const blocks = [];
                document.querySelectorAll('#editor-blocks-list .edit-card').forEach(el => {
                    const type = el.dataset.type;
                    const b = { type: type };
                    if(type === 'section') {
                        b.heading = el.querySelector('.b-head').value;
                        b.content = el.querySelector('.b-content').value;
                    } else if(type === 'image' || type === 'video') {
                        b.url = el.querySelector('.b-url').value;
                    } else if(type === 'table') {
                        b.data = [];
                        el.querySelectorAll('tr').forEach(tr => {
                            const row = [];
                            tr.querySelectorAll('.cell-val').forEach(td => row.push(td.value));
                            if(row.length > 0) b.data.push(row);
                        });
                    }
                    blocks.push(b);
                });
                return {
                    title: app.data.title,
                    infobox: { image: document.getElementById('edit-ib-img').value, rows: ibRows },
                    blocks: blocks
                };
            }
        };

        app.init();
    </script>
</body>
</html>
